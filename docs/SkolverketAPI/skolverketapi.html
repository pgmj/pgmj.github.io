<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Magnus Johansson">
<meta name="author" content="Jens Mattsson">
<meta name="dcterms.date" content="2023-07-18">
<title>R, Rasch, etc - Data retrieval with R using API calls</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><link rel="stylesheet" href="../styles.css">
<link rel="stylesheet" href="api-styles.css">
<meta property="og:title" content="R, Rasch, etc - Data retrieval with R using API calls">
<meta property="og:description" content="The Swedish National Agency for Education database API">
<meta property="og:site-name" content="R, Rasch, etc">
<meta name="twitter:title" content="R, Rasch, etc - Data retrieval with R using API calls">
<meta name="twitter:description" content="The Swedish National Agency for Education database API">
<meta name="twitter:card" content="summary">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">R, Rasch, etc</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../raschrvignette/RaschRvign.html">
 <span class="menu-text">RISEkbmRasch vignette</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-blog" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Blog</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-blog">
<li>
    <a class="dropdown-item" href="../parameterizedQ.html">
 <span class="dropdown-text">Automating reports with Quarto</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../latentResp/LatentResponse.html">
 <span class="dropdown-text">What’s in a latent trait score?</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pgmj/pgmj.github.io"><i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
<div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background"><span class="toc-section-number">1</span>  Background</a></li>
  <li><a href="#setting-up" id="toc-setting-up" class="nav-link" data-scroll-target="#setting-up"><span class="toc-section-number">2</span>  Setting up</a></li>
  <li>
<a href="#getting-data-for-one-municipality" id="toc-getting-data-for-one-municipality" class="nav-link" data-scroll-target="#getting-data-for-one-municipality"><span class="toc-section-number">3</span>  Getting data for one municipality</a>
  <ul class="collapse">
<li><a href="#data-from-one-school" id="toc-data-from-one-school" class="nav-link" data-scroll-target="#data-from-one-school"><span class="toc-section-number">3.1</span>  Data from one school</a></li>
  <li><a href="#data-wrangling" id="toc-data-wrangling" class="nav-link" data-scroll-target="#data-wrangling"><span class="toc-section-number">3.2</span>  Data wrangling</a></li>
  <li><a href="#getting-data-from-multiple-schools" id="toc-getting-data-from-multiple-schools" class="nav-link" data-scroll-target="#getting-data-from-multiple-schools"><span class="toc-section-number">3.3</span>  Getting data from multiple schools</a></li>
  <li><a href="#unnesting-multiple-lists" id="toc-unnesting-multiple-lists" class="nav-link" data-scroll-target="#unnesting-multiple-lists"><span class="toc-section-number">3.4</span>  Unnesting multiple lists</a></li>
  <li><a href="#troubleshooting" id="toc-troubleshooting" class="nav-link" data-scroll-target="#troubleshooting"><span class="toc-section-number">3.5</span>  Troubleshooting</a></li>
  <li><a href="#data-retrieval-with-filtering-on-school-types" id="toc-data-retrieval-with-filtering-on-school-types" class="nav-link" data-scroll-target="#data-retrieval-with-filtering-on-school-types"><span class="toc-section-number">3.6</span>  Data retrieval with filtering on school types</a></li>
  <li><a href="#combining-dataframes" id="toc-combining-dataframes" class="nav-link" data-scroll-target="#combining-dataframes"><span class="toc-section-number">3.7</span>  Combining dataframes</a></li>
  </ul>
</li>
  <li>
<a href="#variables" id="toc-variables" class="nav-link" data-scroll-target="#variables"><span class="toc-section-number">4</span>  Variables</a>
  <ul class="collapse">
<li><a href="#types" id="toc-types" class="nav-link" data-scroll-target="#types"><span class="toc-section-number">4.1</span>  Types</a></li>
  <li><a href="#recoding" id="toc-recoding" class="nav-link" data-scroll-target="#recoding"><span class="toc-section-number">4.2</span>  Recoding</a></li>
  </ul>
</li>
  <li>
<a href="#visualizing-data" id="toc-visualizing-data" class="nav-link" data-scroll-target="#visualizing-data"><span class="toc-section-number">5</span>  Visualizing data</a>
  <ul class="collapse">
<li><a href="#variable-check" id="toc-variable-check" class="nav-link" data-scroll-target="#variable-check"><span class="toc-section-number">5.1</span>  Variable check</a></li>
  <li><a href="#number-of-pupils-per-school" id="toc-number-of-pupils-per-school" class="nav-link" data-scroll-target="#number-of-pupils-per-school"><span class="toc-section-number">5.2</span>  Number of pupils per school</a></li>
  <li><a href="#studentsperteacherquota" id="toc-studentsperteacherquota" class="nav-link" data-scroll-target="#studentsperteacherquota"><span class="toc-section-number">5.3</span>  studentsPerTeacherQuota</a></li>
  </ul>
</li>
  <li><a href="#more-demographics" id="toc-more-demographics" class="nav-link" data-scroll-target="#more-demographics"><span class="toc-section-number">6</span>  More demographics</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Data retrieval with R using API calls</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">The Swedish National Agency for Education database API</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    Magnus Johansson <a href="https://orcid.org/0000-0003-1669-592X" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://ri.se/shic">
            RISE Research Institutes of Sweden
            </a>
          </p>
      </div>
      <div class="quarto-title-meta-contents">
    Jens Mattsson 
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://ri.se/shic">
            RISE Research Institutes of Sweden
            </a>
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2023-07-18</p>
    </div>
  </div>
  
    
  </div>
  

</header><section id="background" class="level2" data-number="1"><h2 data-number="1" class="anchored" data-anchor-id="background">
<span class="header-section-number">1</span> Background</h2>
<p>This is a post documenting explorative work to retrieve data using the <a href="https://www.skolverket.se/om-oss/oppna-data/api-for-skolenhetsregistret">database API</a> maintained Swedish National Agency for Education. The conditions for using the API and database are described in the <a href="https://creativecommons.org/publicdomain/zero/1.0/deed.en">CC0 1.0 license</a>. The API is documented here: <a href="https://api.skolverket.se/skolenhetsregistret/swagger-ui/index.html" class="uri">https://api.skolverket.se/skolenhetsregistret/swagger-ui/index.html</a>.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please note that this is just documentation of our work, not a guide. There will be mistakes and suboptimal routes taken. But in the end I hope we will produce something that may be useful to others. Not everyone will be interested in using the API for the same purpose as we had, so hopefully our troubleshooting will make the potential use wider.</p>
</div>
</div>
<p>A lot of the output will be in Swedish, but you will probably be able to follow along even if your Swedish knowledge is limited. Basic word list:</p>
<ul>
<li>school = skola</li>
<li>school unit code = Skolenhetskod</li>
</ul>
<p>The purpose of this is two-fold. First, various kinds of data on school and municipality levels are of interest in the project <a href="https://www.ri.se/en/what-we-do/projects/data-in-dialogue-risk-and-protective-factors-for-children-and-youth">“Data in dialogue”</a>. Second, in order to conduct analysis of missing data and selection bias we need demographic data about students at the schools participating in school surveys that are used to assess risk and protective factors.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>While this blog post is written by me (Magnus), a lot of the initial trial and error work was done by my colleague Jens Mattsson.</p>
</div>
</div>
</section><section id="setting-up" class="level2" data-number="2"><h2 data-number="2" class="anchored" data-anchor-id="setting-up">
<span class="header-section-number">2</span> Setting up</h2>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-1_64e245bbb881ab00e3d307964281b0f7">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/">httr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/">arrow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/alexcb/rjson">rjson</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://arxiv.org/abs/1403.2805">jsonlite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>First, let’s get a list of municipalities and their codes. The first two numbers in the four number code denotes the region. Sweden has 290 municipalities and 21 regions. For this project, we are interested in the regions of Stockholm and Uppsala, which have codes 01 and 03.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-2_4b666ae02053d40813d5692dbc745eb9">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">municipalities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html">read_parquet</a></span><span class="op">(</span><span class="st">"2023-03-28_KOLADA_Municipality_list.parquet"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">id</span>, <span class="st">"^01|^03"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="va">type</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">municipalities</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 34
Columns: 2
$ id    &lt;chr&gt; "0127", "0162", "0125", "0381", "0136", "0331", "0126", "0305", …
$ title &lt;chr&gt; "Botkyrka", "Danderyd", "Ekerö", "Enköping", "Haninge", "Heby", …</code></pre>
</div>
</div>
</section><section id="getting-data-for-one-municipality" class="level2" data-number="3"><h2 data-number="3" class="anchored" data-anchor-id="getting-data-for-one-municipality">
<span class="header-section-number">3</span> Getting data for one municipality</h2>
<p>Looking at the specifications of the API, we should be able to get all schools in a municipality by doing a call according to <code>/v1/kommun/{municipalityCode}</code>. Unfortunately, the API does not seem to allow making one call for multiple municipalities. The base URL is <code>https://api.skolverket.se/skolenhetsregistret</code>.</p>
<p>We’ll start by getting data from one municipality.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-3_59e1f53f111d26ffd8467dfa7f27c785">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="st">"https://api.skolverket.se/skolenhetsregistret/v1/kommun/0127"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="st">"text"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ Uttagsdatum: chr "2023-07-17T10:06:08.3666049+02:00"
 $ Fotnot     : NULL
 $ Skolenheter:'data.frame':    66 obs. of  5 variables:
  ..$ Skolenhetskod : chr [1:66] "98152284" "84411355" "82464552" "16762245" ...
  ..$ Kommunkod     : chr [1:66] "0127" "0127" "0127" "0127" ...
  ..$ PeOrgNr       : chr [1:66] "2120002882" "5565661815" "5562575786" "8024242391" ...
  ..$ Skolenhetsnamn: chr [1:66] "Blåklintskolan särskola" "Kunskapsskolan Tumba" "Praktiska Tumba" "Edessaskolan" ...
  ..$ Status        : chr [1:66] "Vilande" "Aktiv" "Vilande" "Aktiv" ...</code></pre>
</div>
</div>
<p>We get a list of 3, where the data of interest seems to be within the nested dataframe <code>$Skolenheter</code>. Let’s subset that into its own dataframe object.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-4_33509ac586e473a78b2e52b4381dee69">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schools</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Skolenheter</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">schools</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 66
Columns: 5
$ Skolenhetskod  &lt;chr&gt; "98152284", "84411355", "82464552", "16762245", "751689…
$ Kommunkod      &lt;chr&gt; "0127", "0127", "0127", "0127", "0127", "0127", "0127",…
$ PeOrgNr        &lt;chr&gt; "2120002882", "5565661815", "5562575786", "8024242391",…
$ Skolenhetsnamn &lt;chr&gt; "Blåklintskolan särskola", "Kunskapsskolan Tumba", "Pra…
$ Status         &lt;chr&gt; "Vilande", "Aktiv", "Vilande", "Aktiv", "Vilande", "Akt…</code></pre>
</div>
</div>
<p>Now, this is just a list of schools and their unit codes (<code>schools$Skolenhetskod</code>), it contains no data. But we need this list to know which school unit codes to retrieve data for. There is also a <code>Status</code> variable which seems to have the options of active or not.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-5_0c37d8bc1f6c32e0bb432fc2124c110b">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schools</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">Status</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>    Status  n
1    Aktiv 47
2 Planerad  2
3  Vilande 17</code></pre>
</div>
</div>
<p>There was also a third option for “planned”. Not sure how to use this information at this point.</p>
<section id="data-from-one-school" class="level3" data-number="3.1"><h3 data-number="3.1" class="anchored" data-anchor-id="data-from-one-school">
<span class="header-section-number">3.1</span> Data from one school</h3>
<p>We’ll retrieve data for one school first.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-6_d981d7a8a8d9529b8b2eeac8fdd223b1">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="st">"https://api.skolverket.se/skolenhetsregistret/v1/skolenhet/84411355"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="st">"text"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">sdata</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ Uttagsdatum  : chr "2023-07-17T02:15:09.2287954+02:00"
 $ Fotnot       : NULL
 $ SkolenhetInfo:List of 19
  ..$ Namn               : chr "Kunskapsskolan Tumba"
  ..$ Rektorsnamn        : chr "Henrik von Knorring"
  ..$ Skolenhetskod      : chr "84411355"
  ..$ Epost              : chr "info.tumba@kunskapsskolan.se"
  ..$ Telefon            : chr "0733-173445"
  ..$ Webbadress         : chr "https://www.kunskapsskolan.se"
  ..$ Besoksadress       :List of 4
  .. ..$ Adress : chr "Hans Stahles väg 17"
  .. ..$ Postnr : chr "14741"
  .. ..$ Ort    : chr "Tumba"
  .. ..$ GeoData:List of 5
  ..$ Leveransadress     :List of 3
  .. ..$ Adress: chr "Hans Stahles väg 17"
  .. ..$ Postnr: chr "14741"
  .. ..$ Ort   : chr "Tumba"
  ..$ Utdelningsadress   :List of 3
  .. ..$ Adress: chr "Hans Stahles väg 17"
  .. ..$ Postnr: chr "14741"
  .. ..$ Ort   : chr "Tumba"
  ..$ Inriktningstyp     : chr "Allmän"
  ..$ Skolenhetstyp      : chr "Skolenhet"
  ..$ SkolaNamn          : chr "Kunskapsskolan Tumba"
  ..$ Skolformer         :'data.frame': 1 obs. of  15 variables:
  .. ..$ type        : chr "Grundskola"
  .. ..$ Benamning   : chr "Grundskola"
  .. ..$ SkolformID  : int 5
  .. ..$ SkolformKod : chr "11"
  .. ..$ Ak1         : logi FALSE
  .. ..$ Ak2         : logi FALSE
  .. ..$ Ak3         : logi FALSE
  .. ..$ Ak4         : logi TRUE
  .. ..$ Ak5         : logi TRUE
  .. ..$ Ak6         : logi TRUE
  .. ..$ Ak7         : logi TRUE
  .. ..$ Ak8         : logi TRUE
  .. ..$ Ak9         : logi TRUE
  .. ..$ Resursskola : logi FALSE
  .. ..$ Sjukhusskola: logi FALSE
  ..$ Kommun             :List of 2
  .. ..$ Kommunkod: chr "0127"
  .. ..$ Namn     : chr "Botkyrka"
  ..$ Huvudman           :List of 3
  .. ..$ PeOrgNr: chr "5565661815"
  .. ..$ Namn   : chr "Kunskapsskolan i Sverige Aktiebolag"
  .. ..$ Typ    : chr "Enskild"
  ..$ Skolenhet_ValidFrom: chr "2022-09-07T00:00:00"
  ..$ Status             : chr "Aktiv"
  ..$ Startdatum         : chr "2013-10-01"
  ..$ Nedlaggningsdatum  : NULL</code></pre>
</div>
</div>
<p>This provides a lot of information about the school itself, which can be useful. There is also a version 3 of the API, which contains more information:</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-7_5b925195ea9089d79649ec60256696b1">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sdataV3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/84411355"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="st">"text"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">sdataV3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ status : chr "OK"
 $ message: chr ""
 $ body   :List of 16
  ..$ code                      : chr "84411355"
  ..$ name                      : chr "Kunskapsskolan Tumba"
  ..$ contactInfo               :List of 4
  .. ..$ email    : NULL
  .. ..$ web      : chr "https://www.kunskapsskolan.se"
  .. ..$ telephone: chr "0733-173445"
  .. ..$ addresses:'data.frame':    2 obs. of  4 variables:
  ..$ geographicalAreaCode      : chr "0127"
  ..$ wgs84_Lat                 : chr "59.20011169538554"
  ..$ wgs84_Long                : chr "17.846722627859616"
  ..$ sweRef_N                  : chr "6565805"
  ..$ sweRef_E                  : chr "662569"
  ..$ organisationRegistryNumber: chr "5565661815"
  ..$ principalOrganizerType    : chr "Fristående"
  ..$ corporationName           : chr "Kunskapsskolan i Sverige Aktiebolag"
  ..$ companyForm               : chr "Övriga aktiebolag"
  ..$ schoolOrientation         : chr "Allmän"
  ..$ typeOfSchooling           :'data.frame':  1 obs. of  3 variables:
  .. ..$ code       : chr "gr"
  .. ..$ displayName: chr "Grundskolan"
  .. ..$ schoolYears:List of 1
  ..$ abroadSchool              : logi FALSE
  ..$ _links                    :List of 2
  .. ..$ self      :List of 1
  .. ..$ statistics:List of 1</code></pre>
</div>
</div>
<p>Can we find statistics for the school?</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-8_ee58ccae2a67c9b13c72f068cf2b4b31">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/84411355/statistics"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="st">"text"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ status : chr "OK"
 $ message: chr ""
 $ body   :List of 1
  ..$ _links:List of 2
  .. ..$ gr-statistics:List of 1
  .. ..$ self         :List of 1</code></pre>
</div>
</div>
<p>No data, but some clues:</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-9_4f607329a88a59ba6b5259e291eab011">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">`_links`</span><span class="op">$</span><span class="va">`gr-statistics`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>$href
[1] "https://api.skolverket.se/planned-educations/v3/school-units/84411355/statistics/gr"</code></pre>
</div>
</div>
<p>We’ll try that URL.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-10_7baa731d601b73ee035c4453e82e5c4f">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/84411355/statistics/gr"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="st">"text"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ status : chr "OK"
 $ message: chr ""
 $ body   :List of 24
  ..$ schoolUnit                                           : chr "84411355"
  ..$ specialTeacherPositions                              :'data.frame':   5 obs. of  3 variables:
  .. ..$ value     : chr [1:5] "." "." "." "." ...
  .. ..$ valueType : chr [1:5] "MISSING" "MISSING" "MISSING" "MISSING" ...
  .. ..$ timePeriod: chr [1:5] "2022/23" "2021/22" "2020/21" "2019/20" ...
  ..$ studentsPerTeacherQuota                              :'data.frame':   5 obs. of  3 variables:
  .. ..$ value     : chr [1:5] "15,5" "14,8" "16,6" "16,3" ...
  .. ..$ valueType : chr [1:5] "EXISTS" "EXISTS" "EXISTS" "EXISTS" ...
  .. ..$ timePeriod: chr [1:5] "2022/23" "2021/22" "2020/21" "2019/20" ...
  ..$ certifiedTeachersQuota                               :'data.frame':   5 obs. of  3 variables:
  .. ..$ value     : chr [1:5] "67,4" "60,9" "56,2" "47,0" ...
  .. ..$ valueType : chr [1:5] "EXISTS" "EXISTS" "EXISTS" "EXISTS" ...
  .. ..$ timePeriod: chr [1:5] "2022/23" "2021/22" "2020/21" "2019/20" ...
  ..$ docLinks                                             : NULL
  ..$ hasLibrary                                           : logi FALSE
  ..$ specialEducatorsQuota                                :'data.frame':   5 obs. of  3 variables:
  .. ..$ value     : chr [1:5] "." "." "." "." ...
  .. ..$ valueType : chr [1:5] "MISSING" "MISSING" "MISSING" "MISSING" ...
  .. ..$ timePeriod: chr [1:5] "2022/23" "2021/22" "2020/21" "2019/20" ...
  ..$ totalNumberOfPupils                                  :'data.frame':   1 obs. of  3 variables:
  .. ..$ value     : chr "cirka 370"
  .. ..$ valueType : chr "EXISTS"
  .. ..$ timePeriod: chr "2022/23"
  ..$ ratioOfPupilsIn6thGradeWithAllSubjectsPassed         :'data.frame':   1 obs. of  3 variables:
  .. ..$ value     : chr "61,0"
  .. ..$ valueType : chr "EXISTS"
  .. ..$ timePeriod: chr "2021/22"
  ..$ averageResultNationalTestsSubjectSVE6thGrade         :'data.frame':   3 obs. of  3 variables:
  .. ..$ value     : chr [1:3] "13,4" "14,4" "13,6"
  .. ..$ valueType : chr [1:3] "EXISTS" "EXISTS" "EXISTS"
  .. ..$ timePeriod: chr [1:3] "2021/22" "2018/19" "2017/18"
  ..$ averageResultNationalTestsSubjectENG6thGrade         :'data.frame':   3 obs. of  3 variables:
  .. ..$ value     : chr [1:3] "16,0" "15,8" "15,4"
  .. ..$ valueType : chr [1:3] "EXISTS" "EXISTS" "EXISTS"
  .. ..$ timePeriod: chr [1:3] "2021/22" "2018/19" "2017/18"
  ..$ averageResultNationalTestsSubjectMA6thGrade          :'data.frame':   3 obs. of  3 variables:
  .. ..$ value     : chr [1:3] "9,5" "10,9" "12,4"
  .. ..$ valueType : chr [1:3] "EXISTS" "EXISTS" "EXISTS"
  .. ..$ timePeriod: chr [1:3] "2021/22" "2018/19" "2017/18"
  ..$ averageResultNationalTestsSubjectSVA6thGrade         :'data.frame':   3 obs. of  3 variables:
  .. ..$ value     : chr [1:3] "10,2" ".." ".."
  .. ..$ valueType : chr [1:3] "EXISTS" "OMITTED_DUE_TO_BASED_ON_FEW_PUPILS" "OMITTED_DUE_TO_BASED_ON_FEW_PUPILS"
  .. ..$ timePeriod: chr [1:3] "2021/22" "2018/19" "2017/18"
  ..$ averageResultNationalTestsSubjectSVE9thGrade         :'data.frame':   3 obs. of  3 variables:
  .. ..$ value     : chr [1:3] "14,4" "15,4" "14,5"
  .. ..$ valueType : chr [1:3] "EXISTS" "EXISTS" "EXISTS"
  .. ..$ timePeriod: chr [1:3] "2021/22" "2018/19" "2017/18"
  ..$ averageResultNationalTestsSubjectENG9thGrade         :'data.frame':   3 obs. of  3 variables:
  .. ..$ value     : chr [1:3] "17,1" "16,1" "15,1"
  .. ..$ valueType : chr [1:3] "EXISTS" "EXISTS" "EXISTS"
  .. ..$ timePeriod: chr [1:3] "2021/22" "2018/19" "2017/18"
  ..$ averageResultNationalTestsSubjectMA9thGrade          :'data.frame':   3 obs. of  3 variables:
  .. ..$ value     : chr [1:3] "12,1" "11,9" "."
  .. ..$ valueType : chr [1:3] "EXISTS" "EXISTS" "MISSING"
  .. ..$ timePeriod: chr [1:3] "2021/22" "2018/19" "2017/18"
  ..$ averageResultNationalTestsSubjectSVA9thGrade         :'data.frame':   3 obs. of  3 variables:
  .. ..$ value     : chr [1:3] "14,6" "15,3" "13,6"
  .. ..$ valueType : chr [1:3] "EXISTS" "EXISTS" "EXISTS"
  .. ..$ timePeriod: chr [1:3] "2021/22" "2018/19" "2017/18"
  ..$ ratioOfPupilsIn9thGradeWithAllSubjectsPassed         :'data.frame':   5 obs. of  3 variables:
  .. ..$ value     : chr [1:5] "85,2" "89,5" "90,2" "75,0" ...
  .. ..$ valueType : chr [1:5] "EXISTS" "EXISTS" "EXISTS" "EXISTS" ...
  .. ..$ timePeriod: chr [1:5] "2021/22" "2020/21" "2019/20" "2018/19" ...
  ..$ averageGradesMeritRating9thGrade                     :'data.frame':   5 obs. of  3 variables:
  .. ..$ value     : chr [1:5] "254,8" "261,5" "272,3" "249,0" ...
  .. ..$ valueType : chr [1:5] "EXISTS" "EXISTS" "EXISTS" "EXISTS" ...
  .. ..$ timePeriod: chr [1:5] "2021/22" "2020/21" "2019/20" "2018/19" ...
  ..$ ratioOfPupils9thGradeEligibleForNationalProgramYR    :'data.frame':   5 obs. of  3 variables:
  .. ..$ value     : chr [1:5] "93,8" "~100" "~100" "91,7" ...
  .. ..$ valueType : chr [1:5] "EXISTS" "ROUNDED_OFF_DUE_TO_FEW_PUPILS_NOT_ELIGIBLE" "ROUNDED_OFF_DUE_TO_FEW_PUPILS_NOT_ELIGIBLE" "EXISTS" ...
  .. ..$ timePeriod: chr [1:5] "2021/22" "2020/21" "2019/20" "2018/19" ...
  ..$ ratioOfPupils9thGradeEligibleForNationalProgramES    :'data.frame':   5 obs. of  3 variables:
  .. ..$ value     : chr [1:5] "92,6" "94,7" "~100" "90,5" ...
  .. ..$ valueType : chr [1:5] "EXISTS" "EXISTS" "ROUNDED_OFF_DUE_TO_FEW_PUPILS_NOT_ELIGIBLE" "EXISTS" ...
  .. ..$ timePeriod: chr [1:5] "2021/22" "2020/21" "2019/20" "2018/19" ...
  ..$ ratioOfPupils9thGradeEligibleForNationalProgramSAEKHU:'data.frame':   5 obs. of  3 variables:
  .. ..$ value     : chr [1:5] "91,4" "93,7" "~100" "82,1" ...
  .. ..$ valueType : chr [1:5] "EXISTS" "EXISTS" "ROUNDED_OFF_DUE_TO_FEW_PUPILS_NOT_ELIGIBLE" "EXISTS" ...
  .. ..$ timePeriod: chr [1:5] "2021/22" "2020/21" "2019/20" "2018/19" ...
  ..$ ratioOfPupils9thGradeEligibleForNationalProgramNATE  :'data.frame':   5 obs. of  3 variables:
  .. ..$ value     : chr [1:5] "88,9" "94,7" "91,8" "86,9" ...
  .. ..$ valueType : chr [1:5] "EXISTS" "EXISTS" "EXISTS" "EXISTS" ...
  .. ..$ timePeriod: chr [1:5] "2021/22" "2020/21" "2019/20" "2018/19" ...
  ..$ _links                                               :List of 1
  .. ..$ self:List of 1</code></pre>
</div>
</div>
<p>It seems like we need to specify the type of school to retrieve the stats. In this case, “gr” for “grundskola”, which corresponds to classes 1-9 in Sweden (ages ~ 7-15).</p>
</section><section id="data-wrangling" class="level3" data-number="3.2"><h3 data-number="3.2" class="anchored" data-anchor-id="data-wrangling">
<span class="header-section-number">3.2</span> Data wrangling</h3>
<p>Some data wrangling will be needed to get the list() format data into a dataframe that can be used as a template for downloading and merging data for all schools we are interested in.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-11_2dbf5dee276ccb21dac75f2778d6e376">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">stats</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="va">body</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"ratioOfPupils9thGradeEligibleForNationalProgramNATE"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>So that works to get one list out. Now let’s do all that contain a variable named <code>value</code> and get them in a single dataframe. A relatively simple way to do this (in the current data) is to filter the list elements that contain more than one value.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-12_61ed07abf6728a881f8a8fe902986338">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">body</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code> [1] "specialTeacherPositions"                              
 [2] "studentsPerTeacherQuota"                              
 [3] "certifiedTeachersQuota"                               
 [4] "specialEducatorsQuota"                                
 [5] "totalNumberOfPupils"                                  
 [6] "ratioOfPupilsIn6thGradeWithAllSubjectsPassed"         
 [7] "averageResultNationalTestsSubjectSVE6thGrade"         
 [8] "averageResultNationalTestsSubjectENG6thGrade"         
 [9] "averageResultNationalTestsSubjectMA6thGrade"          
[10] "averageResultNationalTestsSubjectSVA6thGrade"         
[11] "averageResultNationalTestsSubjectSVE9thGrade"         
[12] "averageResultNationalTestsSubjectENG9thGrade"         
[13] "averageResultNationalTestsSubjectMA9thGrade"          
[14] "averageResultNationalTestsSubjectSVA9thGrade"         
[15] "ratioOfPupilsIn9thGradeWithAllSubjectsPassed"         
[16] "averageGradesMeritRating9thGrade"                     
[17] "ratioOfPupils9thGradeEligibleForNationalProgramYR"    
[18] "ratioOfPupils9thGradeEligibleForNationalProgramES"    
[19] "ratioOfPupils9thGradeEligibleForNationalProgramSAEKHU"
[20] "ratioOfPupils9thGradeEligibleForNationalProgramNATE"  </code></pre>
</div>
</div>
<p>Then we can bind them together.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-13_6905eb1f1c26497362cd1c2acef8a635">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create empty dataframe to store output of loop in</span></span>
<span><span class="va">df_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="va">body</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html">add_column</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="va">df_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">df_total</span>,<span class="va">tmp</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">df_total</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 76
Columns: 4
$ value      &lt;chr&gt; ".", ".", ".", ".", ".", "15,5", "14,8", "16,6", "16,3", "1…
$ valueType  &lt;chr&gt; "MISSING", "MISSING", "MISSING", "MISSING", "MISSING", "EXI…
$ timePeriod &lt;chr&gt; "2022/23", "2021/22", "2020/21", "2019/20", "2018/19", "202…
$ variable   &lt;chr&gt; "specialTeacherPositions", "specialTeacherPositions", "spec…</code></pre>
</div>
</div>
<p>Looks good, although there will probably be a lot of recoding needed later.</p>
</section><section id="getting-data-from-multiple-schools" class="level3" data-number="3.3"><h3 data-number="3.3" class="anchored" data-anchor-id="getting-data-from-multiple-schools">
<span class="header-section-number">3.3</span> Getting data from multiple schools</h3>
<p>Since the API demands that we specify the type of school in the API call, we need to add this information to the list of schools. This means that we first need to retrieve the basic information for each school.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-14_c5de67b4d8ed2b4a1bd34e8c7e7fc62a">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sdataV3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/84411355"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="st">"text"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sdataV3</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">code</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] "gr"</code></pre>
</div>
</div>
<p>So that is where we find the type code for each school.</p>
<section id="check-if-all-schools-have-data-in-the-database." class="level4" data-number="3.3.1"><h4 data-number="3.3.1" class="anchored" data-anchor-id="check-if-all-schools-have-data-in-the-database.">
<span class="header-section-number">3.3.1</span> Check if all schools have data in the database.</h4>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-15_62d5cbf88d9785a3dd771e79e193bc88">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolsAvailable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">schools</span><span class="op">$</span><span class="va">Skolenhetskod</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/http_status.html">http_status</a></span><span class="op">(</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"reason"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="st">"status"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html">add_column</a></span><span class="op">(</span>Skolenhetskod <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="va">schoolsAvailable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">schoolsAvailable</span>, <span class="va">tmp</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">schoolsAvailable</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">status</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>     status  n
1 Not Found 14
2        OK 52</code></pre>
</div>
</div>
<p>14 schools are not in the database and need to be removed from the list of schools before we retrieve data. Maybe they match up with the <code>Status</code> variable?</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-16_4a4ba923f93b5d37ab5d5a429b42d16a">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schools</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">.</span>,<span class="va">schoolsAvailable</span>, by <span class="op">=</span> <span class="st">"Skolenhetskod"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">status</span> <span class="op">==</span> <span class="st">"OK"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>   Skolenhetskod Kommunkod    PeOrgNr                       Skolenhetsnamn
1       98152284      0127 2120002882              Blåklintskolan särskola
2       82464552      0127 5562575786                      Praktiska Tumba
3       75168956      0127 2120002882                      Borggruppen 1GR
4       34165541      0127 8020170026              Stockholms Folkhögskola
5       30755074      0127 2120002882                  Björkhaga Skola 1GR
6       66301878      0127 2120002882         Enheten för språk och kultur
7       96827136      0127 5566446224                       Gryningeskolan
8       58395177      0127 2120002882 S:t Botvids gymnasiums mottagarenhet
9       60492213      0127 2120002882                         Språkcentrum
10      43096141      0127 8024030119            Botkyrka Folkhögskola SFI
11      20171551      0127 2120002882          Tallidsskolan träningsskola
12      75727919      0127 5590247374                 Lumiaskolan Botkyrka
13      26480061      0127 5566139290              Thoren Framtid Botkyrka
14      81020581      0127 2120002882           Borgskolan F-klass Gul 1GR
     Status    status
1   Vilande Not Found
2   Vilande Not Found
3   Vilande Not Found
4   Vilande Not Found
5   Vilande Not Found
6   Vilande Not Found
7   Vilande Not Found
8   Vilande Not Found
9   Vilande Not Found
10  Vilande Not Found
11  Vilande Not Found
12 Planerad Not Found
13 Planerad Not Found
14  Vilande Not Found</code></pre>
</div>
</div>
<p>Indeed, but not a perfect match, since the numbers don’t add up when compared to this:</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-17_085244a954f2e627c86466e86dc54760">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schools</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">Status</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>    Status  n
1    Aktiv 47
2 Planerad  2
3  Vilande 17</code></pre>
</div>
</div>
<p>Proceeding to remove schools unavailable in database.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-18_ba11b6ee6bef096fe5345b09ee6095b9">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolsFiltered</span> <span class="op">&lt;-</span> <span class="va">schools</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">.</span>,<span class="va">schoolsAvailable</span>, by <span class="op">=</span> <span class="st">"Skolenhetskod"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="st">"OK"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="va">status</span><span class="op">)</span></span>
<span></span>
<span><span class="va">schoolTypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">schoolsFiltered</span><span class="op">$</span><span class="va">Skolenhetskod</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="st">"text"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">tmp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">code</span>,</span>
<span>    Skolenhetskod <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>                     </span>
<span>  <span class="va">schoolTypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">schoolTypes</span>,<span class="va">tmp2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span>  </span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">schoolTypes</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 82
Columns: 2
$ type          &lt;chr&gt; "gr", "fsk", "gr", "fsk", "gr", "gy", "gy", "gy", "fsk",…
$ Skolenhetskod &lt;chr&gt; "84411355", "16762245", "16762245", "29524966", "2952496…</code></pre>
</div>
</div>
<p>Hmm. We have 82 schools now, rather than 52. Maybe some schools have multiple types?</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-19_e7f7badf92676d66353a135550de0923">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolTypes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">Skolenhetskod</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>   Skolenhetskod n
1       10495223 2
2       10657244 2
3       15620768 2
4       16762245 2
5       18534178 2
6       25506439 2
7       25918983 2
8       29524966 2
9       36350546 2
10      38661388 2
11      40631085 2
12      43238662 2
13      45757947 2
14      51863294 2
15      53426548 2
16      56417100 2
17      57228484 2
18      57850353 2
19      58310322 2
20      67742754 2
21      71048800 2
22      75580959 2
23      80378022 3
24      80731562 2
25      84891659 2
26      86192571 2
27      86985859 2
28      96113241 3</code></pre>
</div>
</div>
</section><section id="data-retrieval" class="level4" data-number="3.3.2"><h4 data-number="3.3.2" class="anchored" data-anchor-id="data-retrieval">
<span class="header-section-number">3.3.2</span> Data retrieval</h4>
<p>Since we have two variables to loop over, we could use a nested <code>for()</code> loop, but we could also use <code><a href="https://purrr.tidyverse.org/reference/map2.html">map2()</a></code> to retrieve data for all schools.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-20_183ad60cce35257338155ba19c6e0e21">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span></span>
<span>  .x <span class="op">=</span> <span class="va">schoolTypes</span><span class="op">$</span><span class="va">Skolenhetskod</span>,</span>
<span>  .y <span class="op">=</span> <span class="va">schoolTypes</span><span class="op">$</span><span class="va">type</span>,</span>
<span>  <span class="op">~</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/"</span>, <span class="va">.x</span>,<span class="st">"/statistics/"</span>, <span class="va">.y</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="st">"text"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="unnesting-multiple-lists" class="level3" data-number="3.4"><h3 data-number="3.4" class="anchored" data-anchor-id="unnesting-multiple-lists">
<span class="header-section-number">3.4</span> Unnesting multiple lists</h3>
<p>Next step is to get each schools data from a list element to a dataframe, and then combine all of them. We already did the first part for one school, so let’s expand on that.</p>
<p>We’ll define a function to get the data from one school.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-21_0c509b0e3f5bda0de7df76a07d172dec">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">oneSchool</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">listN</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">schoolUnit</span> <span class="op">&lt;-</span> <span class="va">schoolData</span><span class="op">[[</span><span class="va">listN</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">schoolUnit</span></span>
<span>  <span class="va">df_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">schoolData</span><span class="op">[[</span><span class="va">listN</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">body</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html">add_column</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">i</span>,</span>
<span>                 Skolenhetskod <span class="op">=</span> <span class="va">schoolUnit</span><span class="op">)</span></span>
<span>    <span class="va">df_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">df_total</span>, <span class="va">tmp</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df_total</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Test the function.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-22_abe979285e6f5c8470b0c418b2f49d97">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">oneSchool</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>   value valueType timePeriod                variable Skolenhetskod
1      .   MISSING    2022/23 specialTeacherPositions      84411355
2      .   MISSING    2021/22 specialTeacherPositions      84411355
3      .   MISSING    2020/21 specialTeacherPositions      84411355
4      .   MISSING    2019/20 specialTeacherPositions      84411355
5      .   MISSING    2018/19 specialTeacherPositions      84411355
6   15,5    EXISTS    2022/23 studentsPerTeacherQuota      84411355
7   14,8    EXISTS    2021/22 studentsPerTeacherQuota      84411355
8   16,6    EXISTS    2020/21 studentsPerTeacherQuota      84411355
9   16,3    EXISTS    2019/20 studentsPerTeacherQuota      84411355
10  15,3    EXISTS    2018/19 studentsPerTeacherQuota      84411355</code></pre>
</div>
</div>
<p>Looks good.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-23_e982483805dc45aa2b485c54bfaf6077">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nestedOutput</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">schoolData</span><span class="op">)</span><span class="op">)</span>, <span class="op">~</span> <span class="fu">oneSchool</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This fails at index 2. <strong>(Code is not run since it won’t allow the output to be rendered)</strong></p>
</section><section id="troubleshooting" class="level3" data-number="3.5"><h3 data-number="3.5" class="anchored" data-anchor-id="troubleshooting">
<span class="header-section-number">3.5</span> Troubleshooting</h3>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-24_e0868e90b780a86b4c49f0f5a1ad2363">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolData</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">body</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>$schoolUnit
[1] "16762245"

$specialTeacherPositions
  value valueType timePeriod
1     .   MISSING    2022/23
2     .   MISSING    2021/22
3     .   MISSING    2020/21
4     .   MISSING    2019/20
5     .   MISSING    2018/19

$studentsPerTeacherQuota
  value valueType timePeriod
1  13,0    EXISTS    2022/23
2  11,0    EXISTS    2021/22
3  12,0    EXISTS    2020/21
4  12,0    EXISTS    2019/20
5  13,7    EXISTS    2018/19

$certifiedTeachersQuota
  value valueType timePeriod
1   0,0    EXISTS    2022/23
2   0,0    EXISTS    2021/22
3  50,0    EXISTS    2020/21
4  50,0    EXISTS    2019/20
5  57,1    EXISTS    2018/19

$docLinks
NULL

$hasLibrary
[1] FALSE

$totalNumberOfPupils
     value valueType timePeriod
1 cirka 30    EXISTS    2022/23

$`_links`
$`_links`$self
$`_links`$self$href
[1] "https://api.skolverket.se/planned-educations/v3/school-units/16762245/statistics/fsk"</code></pre>
</div>
</div>
<p>Looks like not all schools have the same data variables. We’ll have to work that into the function</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-25_60200be3d37f584d77235403376c03d2">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">oneSchool</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">listN</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">schoolUnit</span> <span class="op">&lt;-</span> <span class="va">schoolData</span><span class="op">[[</span><span class="va">listN</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">schoolUnit</span></span>
<span>  <span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">schoolData</span><span class="op">[[</span><span class="va">listN</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">body</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">df_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">schoolData</span><span class="op">[[</span><span class="va">listN</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">body</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html">add_column</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">i</span>,</span>
<span>                 Skolenhetskod <span class="op">=</span> <span class="va">schoolUnit</span><span class="op">)</span></span>
<span>    <span class="va">df_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">df_total</span>, <span class="va">tmp</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df_total</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-26_851e6d3437e4950bd79a3f4ba33f09ab">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nestedOutput</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">schoolData</span><span class="op">)</span><span class="op">)</span>, <span class="op">~</span> <span class="fu">oneSchool</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Failing at index 6… <strong>(Code is not run since it won’t allow the output to be rendered)</strong></p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-27_b21c985f1639715a3073175856f5f81b">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolData</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">programMetrics</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>  programCode averageResultNationalTestsSubjectSVE sveSubjectTest
1          EK                   13,1, EXISTS, VT22      Svenska 3
2         IMV                      NA, MISSING, NA           &lt;NA&gt;
3          NA                   15,5, EXISTS, VT22      Svenska 3
4          SA                   12,7, EXISTS, VT22      Svenska 3
5          TE                   15,7, EXISTS, VT22      Svenska 3
          averageResultNationalTestsSubjectSVA           svaSubjectTest
1 .., OMITTED_DUE_TO_BASED_ON_FEW_PUPILS, VT22 Svenska som andraspråk 3
2                              NA, MISSING, NA                     &lt;NA&gt;
3                           15,9, EXISTS, VT22 Svenska som andraspråk 3
4                           14,0, EXISTS, VT22 Svenska som andraspråk 3
5 .., OMITTED_DUE_TO_BASED_ON_FEW_PUPILS, VT22 Svenska som andraspråk 3
  averageResultNationalTestsSubjectMA1 ma1SubjectTest
1                   11,8, EXISTS, VT22   Matematik 2B
2                      NA, MISSING, NA           &lt;NA&gt;
3                      NA, MISSING, NA           &lt;NA&gt;
4                   10,4, EXISTS, VT22   Matematik 2B
5                      NA, MISSING, NA           &lt;NA&gt;
  averageResultNationalTestsSubjectMA2 ma2SubjectTest
1                   10,3, EXISTS, VT22   Matematik 3B
2                      NA, MISSING, NA           &lt;NA&gt;
3                   13,5, EXISTS, VT22    Matematik 4
4                      NA, MISSING, NA           &lt;NA&gt;
5                   11,3, EXISTS, VT22    Matematik 4
  averageResultNationalTestsSubjectENG engSubjectTest schoolUnit
1                   15,8, EXISTS, VT22     Engelska 6   26334561
2                      NA, MISSING, NA           &lt;NA&gt;   26334561
3                   16,4, EXISTS, VT22     Engelska 6   26334561
4                   14,9, EXISTS, VT22     Engelska 6   26334561
5                   16,6, EXISTS, VT22     Engelska 6   26334561
  specialTeacherPositions studentsPerTeacherQuota certifiedTeachersQuota
1    NA, MISSING, 2022/23   16,5, EXISTS, 2022/23  88,7, EXISTS, 2022/23
2    NA, MISSING, 2022/23   16,5, EXISTS, 2022/23  88,7, EXISTS, 2022/23
3    NA, MISSING, 2022/23   16,5, EXISTS, 2022/23  88,7, EXISTS, 2022/23
4    NA, MISSING, 2022/23   16,5, EXISTS, 2022/23  88,7, EXISTS, 2022/23
5    NA, MISSING, 2022/23   16,5, EXISTS, 2022/23  88,7, EXISTS, 2022/23
  docLinks hasLibrary        totalNumberOfPupils
1       NA       TRUE cirka 180, EXISTS, 2022/23
2       NA       TRUE  cirka 10, EXISTS, 2022/23
3       NA       TRUE cirka 210, EXISTS, 2022/23
4       NA       TRUE cirka 180, EXISTS, 2022/23
5       NA       TRUE  cirka 90, EXISTS, 2022/23
                                                                     ratioOfStudentsEligibleForUndergraduateEducation
1 98,4, 100,0, 90,7, 94,7, 100,0, EXISTS, EXISTS, EXISTS, EXISTS, EXISTS, 2021/22, 2020/21, 2019/20, 2018/19, 2017/18
2                                                                                                                NULL
3   96,7, 94,4, 94,4, 94,3, 86,6, EXISTS, EXISTS, EXISTS, EXISTS, EXISTS, 2021/22, 2020/21, 2019/20, 2018/19, 2017/18
4   93,1, 92,7, 87,3, 96,4, 89,4, EXISTS, EXISTS, EXISTS, EXISTS, EXISTS, 2021/22, 2020/21, 2019/20, 2018/19, 2017/18
5                         96,7, 88,9, 100,0, 87,5, EXISTS, EXISTS, EXISTS, EXISTS, 2021/22, 2020/21, 2019/20, 2018/19
                                                                                            gradesPointsForStudents
1 14,2, 14,7, 14,1, 15,0, 14,2, EXISTS, EXISTS, EXISTS, EXISTS, EXISTS, 2021/22, 2020/21, 2019/20, 2018/19, 2017/18
2                                                                                                              NULL
3 15,6, 15,0, 16,5, 15,4, 14,3, EXISTS, EXISTS, EXISTS, EXISTS, EXISTS, 2021/22, 2020/21, 2019/20, 2018/19, 2017/18
4 14,2, 14,6, 14,2, 13,5, 13,6, EXISTS, EXISTS, EXISTS, EXISTS, EXISTS, 2021/22, 2020/21, 2019/20, 2018/19, 2017/18
5                        15,6, 14,9, 15,4, 14,0, EXISTS, EXISTS, EXISTS, EXISTS, 2021/22, 2020/21, 2019/20, 2018/19
                                                                                    gradesPointsForStudentsWithExam
1 14,3, 14,7, 14,4, 15,2, 14,2, EXISTS, EXISTS, EXISTS, EXISTS, EXISTS, 2021/22, 2020/21, 2019/20, 2018/19, 2017/18
2                                                                                                              NULL
3 15,8, 15,3, 16,9, 15,6, 15,1, EXISTS, EXISTS, EXISTS, EXISTS, EXISTS, 2021/22, 2020/21, 2019/20, 2018/19, 2017/18
4 14,6, 15,0, 15,0, 13,8, 14,1, EXISTS, EXISTS, EXISTS, EXISTS, EXISTS, 2021/22, 2020/21, 2019/20, 2018/19, 2017/18
5                        15,7, 15,7, 15,4, 14,9, EXISTS, EXISTS, EXISTS, EXISTS, 2021/22, 2020/21, 2019/20, 2018/19
                                                                                   ratioOfPupilsWithExamWithin3Years
1 96,8, 100,0, 86,0, 91,2, 89,7, EXISTS, EXISTS, EXISTS, EXISTS, EXISTS, 2019/20, 2018/19, 2017/18, 2016/17, 2015/16
2                                                                                                               NULL
3  93,4, 86,9, 86,7, 90,1, 77,8, EXISTS, EXISTS, EXISTS, EXISTS, EXISTS, 2019/20, 2018/19, 2017/18, 2016/17, 2015/16
4  86,4, 83,6, 78,6, 85,7, 74,3, EXISTS, EXISTS, EXISTS, EXISTS, EXISTS, 2019/20, 2018/19, 2017/18, 2016/17, 2015/16
5                        93,8, 83,3, 100,0, 82,4, EXISTS, EXISTS, EXISTS, EXISTS, 2019/20, 2018/19, 2017/18, 2016/17
   admissionPointsMin admissionPointsAverage admissionPointsSemester
1 260,0, EXISTS, 2022    280,0, EXISTS, 2022                      NA
2     NA, MISSING, NA        NA, MISSING, NA                      NA
3 267,5, EXISTS, 2022    305,9, EXISTS, 2022                      NA
4 247,5, EXISTS, 2022    278,8, EXISTS, 2022                      NA
5 270,0, EXISTS, 2022    290,2, EXISTS, 2022                      NA
  specialEducatorsQuota
1   ., MISSING, 2022/23
2   ., MISSING, 2022/23
3   ., MISSING, 2022/23
4   ., MISSING, 2022/23
5   ., MISSING, 2022/23
                                                                                 href
1 https://api.skolverket.se/planned-educations/v3/school-units/26334561/statistics/gy
2 https://api.skolverket.se/planned-educations/v3/school-units/26334561/statistics/gy
3 https://api.skolverket.se/planned-educations/v3/school-units/26334561/statistics/gy
4 https://api.skolverket.se/planned-educations/v3/school-units/26334561/statistics/gy
5 https://api.skolverket.se/planned-educations/v3/school-units/26334561/statistics/gy</code></pre>
</div>
</div>
<p>There is a variable that has more than 3 columns.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-28_c7e8486ee415980e343f91f224fb07a0">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolData</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">schoolUnit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
</div>
<p>No unit code in the data.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-29_708ff454d2ae4e3b410855bdb29cef1a">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolTypes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>  type Skolenhetskod
1   gy      26334561</code></pre>
</div>
</div>
<p>This is a Gymnasieskola.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-30_3b1a764117bf3dccf4f31982c0b196fe">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolTypes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"gy"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>  rowname type Skolenhetskod
1       6   gy      26334561
2       7   gy      40386043
3       8   gy      97758137
4      18   gy      53400472
5      74   gy      60096875</code></pre>
</div>
</div>
<p>Looks like we have 5 of those. Maybe they all share the same structure?</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-31_3c69614ac8d495b51ea3037825771b6e">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">9</span>,<span class="fl">10</span>,<span class="fl">16</span>,<span class="fl">74</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">schoolData</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">body</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "programMetrics"          "specialTeacherPositions"
[3] "studentsPerTeacherQuota" "certifiedTeachersQuota" 
[5] "specialEducatorsQuota"   "totalNumberOfPupils"    

[[2]]
[1] "schoolUnit"              "specialTeacherPositions"
[3] "studentsPerTeacherQuota" "certifiedTeachersQuota" 
[5] "docLinks"                "hasLibrary"             
[7] "totalNumberOfPupils"     "_links"                 

[[3]]
 [1] "schoolUnit"                                           
 [2] "specialTeacherPositions"                              
 [3] "studentsPerTeacherQuota"                              
 [4] "certifiedTeachersQuota"                               
 [5] "docLinks"                                             
 [6] "hasLibrary"                                           
 [7] "specialEducatorsQuota"                                
 [8] "totalNumberOfPupils"                                  
 [9] "ratioOfPupilsIn6thGradeWithAllSubjectsPassed"         
[10] "averageResultNationalTestsSubjectSVE6thGrade"         
[11] "averageResultNationalTestsSubjectENG6thGrade"         
[12] "averageResultNationalTestsSubjectMA6thGrade"          
[13] "averageResultNationalTestsSubjectSVA6thGrade"         
[14] "averageResultNationalTestsSubjectSVE9thGrade"         
[15] "averageResultNationalTestsSubjectENG9thGrade"         
[16] "averageResultNationalTestsSubjectMA9thGrade"          
[17] "averageResultNationalTestsSubjectSVA9thGrade"         
[18] "ratioOfPupilsIn9thGradeWithAllSubjectsPassed"         
[19] "averageGradesMeritRating9thGrade"                     
[20] "ratioOfPupils9thGradeEligibleForNationalProgramYR"    
[21] "ratioOfPupils9thGradeEligibleForNationalProgramES"    
[22] "ratioOfPupils9thGradeEligibleForNationalProgramSAEKHU"
[23] "ratioOfPupils9thGradeEligibleForNationalProgramNATE"  
[24] "_links"                                               

[[4]]
[1] "schoolUnit"              "specialTeacherPositions"
[3] "studentsPerTeacherQuota" "certifiedTeachersQuota" 
[5] "docLinks"                "hasLibrary"             
[7] "totalNumberOfPupils"     "_links"                 

[[5]]
[1] "programMetrics"          "specialTeacherPositions"
[3] "studentsPerTeacherQuota" "certifiedTeachersQuota" 
[5] "specialEducatorsQuota"   "totalNumberOfPupils"    </code></pre>
</div>
</div>
<p>Indeed. We’ll just filter those schools out for now.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-32_8a48d58696d552ba4121999459916f01">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mapSchoolUnits</span> <span class="op">&lt;-</span> <span class="va">schoolTypes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">type</span> <span class="op">==</span> <span class="st">"gy"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">rowname</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-33_6b68a0c35e36b80988a69f718b7b4859">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nestedOutput</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">mapSchoolUnits</span>, <span class="op">~</span> <span class="fu">oneSchool</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Index 19 error.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-34_8b3d86f4e217d6dea805131eacc5b837">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolData</span><span class="op">[[</span><span class="va">mapSchoolUnits</span><span class="op">[</span><span class="fl">19</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>$status
[1] "OK"

$message
[1] ""

$body
$body$schoolUnit
[1] "40631085"

$body$specialTeacherPositions
  value valueType timePeriod
1   1,0    EXISTS    2022/23
2   4,0    EXISTS    2021/22
3   4,0    EXISTS    2020/21
4   3,0    EXISTS    2019/20
5   1,0    EXISTS    2018/19

$body$studentsPerTeacherQuota
  value valueType timePeriod
1  13,1    EXISTS    2022/23
2  12,7    EXISTS    2021/22
3  11,2    EXISTS    2020/21
4  11,5    EXISTS    2019/20
5  11,9    EXISTS    2018/19

$body$certifiedTeachersQuota
  value valueType timePeriod
1  58,9    EXISTS    2022/23
2  53,8    EXISTS    2021/22
3  50,4    EXISTS    2020/21
4  47,5    EXISTS    2019/20
5  48,6    EXISTS    2018/19

$body$docLinks
NULL

$body$hasLibrary
[1] TRUE

$body$specialEducatorsQuota
  value valueType timePeriod
1   5,3    EXISTS    2022/23
2   2,5    EXISTS    2021/22
3   2,4    EXISTS    2020/21
4   2,4    EXISTS    2019/20
5     .   MISSING    2018/19

$body$totalNumberOfPupils
      value valueType timePeriod
1 cirka 500    EXISTS    2022/23

$body$ratioOfPupilsIn6thGradeWithAllSubjectsPassed
  value valueType timePeriod
1  36,8    EXISTS    2021/22

$body$averageResultNationalTestsSubjectSVE6thGrade
  value                          valueType timePeriod
1    .. OMITTED_DUE_TO_BASED_ON_FEW_PUPILS    2021/22
2     .                            MISSING    2018/19
3    .. OMITTED_DUE_TO_BASED_ON_FEW_PUPILS    2017/18

$body$averageResultNationalTestsSubjectENG6thGrade
  value valueType timePeriod
1  14,0    EXISTS    2021/22
2  11,1    EXISTS    2018/19
3  12,4    EXISTS    2017/18

$body$averageResultNationalTestsSubjectMA6thGrade
  value valueType timePeriod
1   9,6    EXISTS    2021/22
2   9,4    EXISTS    2018/19
3   8,8    EXISTS    2017/18

$body$averageResultNationalTestsSubjectSVA6thGrade
  value valueType timePeriod
1   6,9    EXISTS    2021/22
2   9,6    EXISTS    2018/19
3   7,7    EXISTS    2017/18

$body$averageResultNationalTestsSubjectSVE9thGrade
  value                          valueType timePeriod
1    .. OMITTED_DUE_TO_BASED_ON_FEW_PUPILS    2021/22
2    .. OMITTED_DUE_TO_BASED_ON_FEW_PUPILS    2018/19
3     .                            MISSING    2017/18

$body$averageResultNationalTestsSubjectENG9thGrade
  value valueType timePeriod
1  11,9    EXISTS    2021/22
2  12,6    EXISTS    2018/19
3  12,1    EXISTS    2017/18

$body$averageResultNationalTestsSubjectMA9thGrade
  value valueType timePeriod
1  11,7    EXISTS    2021/22
2   8,2    EXISTS    2018/19
3     .   MISSING    2017/18

$body$averageResultNationalTestsSubjectSVA9thGrade
  value valueType timePeriod
1  10,0    EXISTS    2021/22
2  10,9    EXISTS    2018/19
3  12,3    EXISTS    2017/18

$body$ratioOfPupilsIn9thGradeWithAllSubjectsPassed
  value valueType timePeriod
1  57,3    EXISTS    2021/22
2  51,6    EXISTS    2020/21
3  49,4    EXISTS    2019/20
4  50,0    EXISTS    2018/19
5  43,5    EXISTS    2017/18

$body$averageGradesMeritRating9thGrade
  value valueType timePeriod
1 199,8    EXISTS    2021/22
2 194,5    EXISTS    2020/21
3 194,9    EXISTS    2019/20
4 168,6    EXISTS    2018/19
5 168,4    EXISTS    2017/18

$body$ratioOfPupils9thGradeEligibleForNationalProgramYR
  value valueType timePeriod
1  68,8    EXISTS    2021/22
2  73,4    EXISTS    2020/21
3  82,4    EXISTS    2019/20
4  63,2    EXISTS    2018/19
5  65,2    EXISTS    2017/18

$body$ratioOfPupils9thGradeEligibleForNationalProgramES
  value valueType timePeriod
1  67,7    EXISTS    2021/22
2  71,9    EXISTS    2020/21
3  74,1    EXISTS    2019/20
4  63,2    EXISTS    2018/19
5  63,8    EXISTS    2017/18

$body$ratioOfPupils9thGradeEligibleForNationalProgramSAEKHU
  value valueType timePeriod
1  64,6    EXISTS    2021/22
2  70,3    EXISTS    2020/21
3  69,4    EXISTS    2019/20
4  55,3    EXISTS    2018/19
5  50,7    EXISTS    2017/18

$body$ratioOfPupils9thGradeEligibleForNationalProgramNATE
  value valueType timePeriod
1  67,7    EXISTS    2021/22
2  57,8    EXISTS    2020/21
3  55,3    EXISTS    2019/20
4  57,9    EXISTS    2018/19
5  56,5    EXISTS    2017/18

$body$`_links`
$body$`_links`$self
$body$`_links`$self$href
[1] "https://api.skolverket.se/planned-educations/v3/school-units/40631085/statistics/gr"</code></pre>
</div>
</div>
<p>Strange that this school has no data when we tested that earlier. But alas, we’ll just have to remove it. Note that the type is “vux”. We should have filtered on types of interest earlier. This is not really a relevant type for our purposes.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-35_8dc7684f6fd15080662637061d9b10b0">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolTypes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>    type  n
1    fsk 27
2     gr 34
3   gran 10
4     gy  5
5   gyan  2
6    sfi  1
7    vux  2
8 vuxgys  1</code></pre>
</div>
</div>
<p>Let’s get the full descriptions of these abbreviations.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-36_4d417007bf6c623ed3bbae28f50e6fbb">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolTypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">schoolsFiltered</span><span class="op">$</span><span class="va">Skolenhetskod</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="st">"text"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">tmp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">code</span>,</span>
<span>    typeDesc <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">displayName</span>,</span>
<span>    Skolenhetskod <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>                     </span>
<span>  <span class="va">schoolTypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">schoolTypes</span>,<span class="va">tmp2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">schoolTypes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">typeDesc</span>,<span class="va">type</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>                                           typeDesc   type  n
1                               Anpassad grundskola   gran 10
2                            Anpassad gymnasieskola   gyan  2
3                                   Förskoleklassen    fsk 27
4                                       Grundskolan     gr 34
5                                    Gymnasieskolan     gy  5
6 Kommunal vuxenutbildning i svenska för invandrare    sfi  1
7        Kommunal vuxenutbildning på gymnasial nivå    vux  2
8   Särskild utbildning för vuxna på gymnasial nivå vuxgys  1</code></pre>
</div>
</div>
<p>For our purposes, we are primarily interested in gr and gy, and some stats from fsk, but not the rest. This filtering should of course have been done earlier, but the first part of this post was written on a Saturday after 2 weeks of vacation and my brain was not quite up to speed…</p>
</section><section id="data-retrieval-with-filtering-on-school-types" class="level3" data-number="3.6"><h3 data-number="3.6" class="anchored" data-anchor-id="data-retrieval-with-filtering-on-school-types">
<span class="header-section-number">3.6</span> Data retrieval with filtering on school types</h3>
<p>We’ll do them separately this time, starting with “gr” only.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-37_d88e66330c7774af26ce8dab2d7bcab0">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mapSchoolUnits</span> <span class="op">&lt;-</span> <span class="va">schoolTypes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"gr"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">rowname</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>         </span>
<span><span class="va">nestedOutputGR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">mapSchoolUnits</span>, <span class="op">~</span> <span class="fu">oneSchool</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">nestedOutputGR</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 76
Columns: 5
$ value         &lt;chr&gt; ".", ".", ".", ".", ".", "15,5", "14,8", "16,6", "16,3",…
$ valueType     &lt;chr&gt; "MISSING", "MISSING", "MISSING", "MISSING", "MISSING", "…
$ timePeriod    &lt;chr&gt; "2022/23", "2021/22", "2020/21", "2019/20", "2018/19", "…
$ variable      &lt;chr&gt; "specialTeacherPositions", "specialTeacherPositions", "s…
$ Skolenhetskod &lt;chr&gt; "84411355", "84411355", "84411355", "84411355", "8441135…</code></pre>
</div>
</div>
<p>Now each school has its own dataframe, stored within the list object <code>nestedOutputGR</code>. Next step is to combine them into one dataframe.</p>
</section><section id="combining-dataframes" class="level3" data-number="3.7"><h3 data-number="3.7" class="anchored" data-anchor-id="combining-dataframes">
<span class="header-section-number">3.7</span> Combining dataframes</h3>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-38_f48cbaceaac5140a09a3060c2f61905f">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">unnestedOutputGR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">nestedOutputGR</span><span class="op">)</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">bind_rows</span>, <span class="va">nestedOutputGR</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">unnestedOutputGR</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 1,962
Columns: 5
$ value         &lt;chr&gt; ".", ".", ".", ".", ".", "15,5", "14,8", "16,6", "16,3",…
$ valueType     &lt;chr&gt; "MISSING", "MISSING", "MISSING", "MISSING", "MISSING", "…
$ timePeriod    &lt;chr&gt; "2022/23", "2021/22", "2020/21", "2019/20", "2018/19", "…
$ variable      &lt;chr&gt; "specialTeacherPositions", "specialTeacherPositions", "s…
$ Skolenhetskod &lt;chr&gt; "84411355", "84411355", "84411355", "84411355", "8441135…</code></pre>
</div>
</div>
<p>Data is now in long format, which will be useful for some uses, and we can use <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code> to change format when needed.</p>
<p>All variables are class “character”, which is fine for some, but <code>timePeriod</code> is a date variable, and <code>value</code> has “.” for missing and “,” as decimal sign. This needs to be modified.</p>
</section></section><section id="variables" class="level2" data-number="4"><h2 data-number="4" class="anchored" data-anchor-id="variables">
<span class="header-section-number">4</span> Variables</h2>
<p>Let’s have a look at the variables available in the data.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-39_28d4b3288584e8f568f474dc3d7ff1f5">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">unnestedOutputGR</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 2
   variable                                                  n
   &lt;chr&gt;                                                 &lt;int&gt;
 1 averageGradesMeritRating9thGrade                        109
 2 averageResultNationalTestsSubjectENG6thGrade             78
 3 averageResultNationalTestsSubjectENG9thGrade             66
 4 averageResultNationalTestsSubjectMA6thGrade              78
 5 averageResultNationalTestsSubjectMA9thGrade              66
 6 averageResultNationalTestsSubjectSVA6thGrade             78
 7 averageResultNationalTestsSubjectSVA9thGrade             66
 8 averageResultNationalTestsSubjectSVE6thGrade             78
 9 averageResultNationalTestsSubjectSVE9thGrade             66
10 certifiedTeachersQuota                                  166
11 ratioOfPupils9thGradeEligibleForNationalProgramES       109
12 ratioOfPupils9thGradeEligibleForNationalProgramNATE     109
13 ratioOfPupils9thGradeEligibleForNationalProgramSAEKHU   109
14 ratioOfPupils9thGradeEligibleForNationalProgramYR       109
15 ratioOfPupilsIn6thGradeWithAllSubjectsPassed             34
16 ratioOfPupilsIn9thGradeWithAllSubjectsPassed            109
17 specialEducatorsQuota                                   166
18 specialTeacherPositions                                 166
19 studentsPerTeacherQuota                                 166
20 totalNumberOfPupils                                      34</code></pre>
</div>
</div>
<section id="types" class="level3" data-number="4.1"><h3 data-number="4.1" class="anchored" data-anchor-id="types">
<span class="header-section-number">4.1</span> Types</h3>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-40_f7f97396facdce50f32ec20f59945e4b">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">unnestedOutputGR</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">valueType</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  valueType                                             n
  &lt;chr&gt;                                             &lt;int&gt;
1 EXISTS                                             1358
2 MISSING                                             300
3 OMITTED_DUE_TO_BASED_ON_FEW_PUPILS                  216
4 ROUNDED_OFF_DUE_TO_FEW_PUPILS_NOT_ELIGIBLE           73
5 TEACHERS_EXCLUDED_DUE_TO_NO_REQUIRED_LEGITIMATION    15</code></pre>
</div>
</div>
<p>Let’s look at the value variable for the different valueTypes (except EXISTS).</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-41_3dc9aa92d0cfe7280337a4ab28995e59">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">unnestedOutputGR</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">valueType</span> <span class="op">==</span> <span class="st">"EXISTS"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">valueType</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
# Groups:   valueType [4]
  valueType                                         value
  &lt;chr&gt;                                             &lt;chr&gt;
1 MISSING                                           .    
2 OMITTED_DUE_TO_BASED_ON_FEW_PUPILS                ..   
3 ROUNDED_OFF_DUE_TO_FEW_PUPILS_NOT_ELIGIBLE        ~100 
4 TEACHERS_EXCLUDED_DUE_TO_NO_REQUIRED_LEGITIMATION *    
5 MISSING                                           &lt;NA&gt; </code></pre>
</div>
</div>
<p>We need the value variable to be of class numeric, which means only numerics and NA values are allowed.</p>
</section><section id="recoding" class="level3" data-number="4.2"><h3 data-number="4.2" class="anchored" data-anchor-id="recoding">
<span class="header-section-number">4.2</span> Recoding</h3>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-42_7d2a1e80b3a713b842d9c9151d845328">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create copy of dataframe prior to recoding</span></span>
<span><span class="va">df.gr</span> <span class="op">&lt;-</span> <span class="va">unnestedOutputGR</span></span>
<span></span>
<span><span class="co"># recode . to NA</span></span>
<span><span class="va">df.gr</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu">car</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/car/man/recode.html">recode</a></span><span class="op">(</span><span class="va">df.gr</span><span class="op">$</span><span class="va">value</span>,<span class="st">"'.'=NA"</span><span class="op">)</span></span>
<span><span class="co"># change decimal comma to decimal point</span></span>
<span><span class="va">df.gr</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">","</span>,</span>
<span>                    replacement <span class="op">=</span> <span class="st">"."</span>,</span>
<span>                    <span class="va">df.gr</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-43_9fc1af7763be49b7e8cc70e8b47a4554">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># remaining cleanup</span></span>
<span><span class="va">df.gr</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu">car</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/car/man/recode.html">recode</a></span><span class="op">(</span><span class="va">df.gr</span><span class="op">$</span><span class="va">value</span>,<span class="st">"'..'=NA"</span><span class="op">)</span> <span class="co"># too few pupils</span></span>
<span><span class="va">df.gr</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu">car</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/car/man/recode.html">recode</a></span><span class="op">(</span><span class="va">df.gr</span><span class="op">$</span><span class="va">value</span>,<span class="st">"'*'=NA"</span><span class="op">)</span> <span class="co"># no req for teacher license</span></span>
<span><span class="va">df.gr</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"cirka "</span>, <span class="st">""</span>, <span class="va">df.gr</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="va">df.gr</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"~"</span>, <span class="st">""</span>, <span class="va">df.gr</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df.gr</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">df.gr</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="date-variable" class="level4" data-number="4.2.1"><h4 data-number="4.2.1" class="anchored" data-anchor-id="date-variable">
<span class="header-section-number">4.2.1</span> Date variable</h4>
<p>First remove the second part of the school year designation (extract the first 4 digits).</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-44_1fc3241f63a2f63ab1e84825bbdcd094">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># date variable</span></span>
<span><span class="va">df.gr</span><span class="op">$</span><span class="va">timePeriod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">df.gr</span><span class="op">$</span><span class="va">timePeriod</span>, <span class="st">"\\d{4}"</span><span class="op">)</span></span>
<span><span class="va">df.gr</span><span class="op">$</span><span class="va">timePeriod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">df.gr</span><span class="op">$</span><span class="va">timePeriod</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df.gr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">timePeriod</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 2
  timePeriod     n
       &lt;int&gt; &lt;int&gt;
1       2017   314
2       2018   456
3       2019   260
4       2020   262
5       2021   496
6       2022   166
7         NA     8</code></pre>
</div>
</div>
<p>We could transform this to a date format variable, but having dates as year numerics is fine for our intended use.</p>
</section></section></section><section id="visualizing-data" class="level2" data-number="5"><h2 data-number="5" class="anchored" data-anchor-id="visualizing-data">
<span class="header-section-number">5</span> Visualizing data</h2>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-45_d4e34124f881edac40b42642365ce3af">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># we like to use school names instead of codes when creating figures</span></span>
<span><span class="va">df.gr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df.gr</span>,<span class="va">schools</span>, by <span class="op">=</span> <span class="st">"Skolenhetskod"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="variable-check" class="level3" data-number="5.1"><h3 data-number="5.1" class="anchored" data-anchor-id="variable-check">
<span class="header-section-number">5.1</span> Variable check</h3>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-46_5fae36f3ca0260d84d192fa484e09ec7">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ddsjoberg/gtsummary">gtsummary</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">df.gr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">timePeriod</span>,<span class="va">variable</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://www.danieldsjoberg.com/gtsummary/reference/tbl_summary.html">tbl_summary</a></span><span class="op">(</span><span class="va">timePeriod</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">

<div id="twsyuagdcb" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#twsyuagdcb table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#twsyuagdcb thead, #twsyuagdcb tbody, #twsyuagdcb tfoot, #twsyuagdcb tr, #twsyuagdcb td, #twsyuagdcb th {
  border-style: none;
}

#twsyuagdcb p {
  margin: 0;
  padding: 0;
}

#twsyuagdcb .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#twsyuagdcb .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#twsyuagdcb .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#twsyuagdcb .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#twsyuagdcb .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#twsyuagdcb .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#twsyuagdcb .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#twsyuagdcb .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#twsyuagdcb .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#twsyuagdcb .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#twsyuagdcb .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#twsyuagdcb .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#twsyuagdcb .gt_spanner_row {
  border-bottom-style: hidden;
}

#twsyuagdcb .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#twsyuagdcb .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#twsyuagdcb .gt_from_md > :first-child {
  margin-top: 0;
}

#twsyuagdcb .gt_from_md > :last-child {
  margin-bottom: 0;
}

#twsyuagdcb .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#twsyuagdcb .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#twsyuagdcb .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#twsyuagdcb .gt_row_group_first td {
  border-top-width: 2px;
}

#twsyuagdcb .gt_row_group_first th {
  border-top-width: 2px;
}

#twsyuagdcb .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#twsyuagdcb .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#twsyuagdcb .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#twsyuagdcb .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#twsyuagdcb .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#twsyuagdcb .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#twsyuagdcb .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#twsyuagdcb .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#twsyuagdcb .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#twsyuagdcb .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#twsyuagdcb .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#twsyuagdcb .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#twsyuagdcb .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#twsyuagdcb .gt_left {
  text-align: left;
}

#twsyuagdcb .gt_center {
  text-align: center;
}

#twsyuagdcb .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#twsyuagdcb .gt_font_normal {
  font-weight: normal;
}

#twsyuagdcb .gt_font_bold {
  font-weight: bold;
}

#twsyuagdcb .gt_font_italic {
  font-style: italic;
}

#twsyuagdcb .gt_super {
  font-size: 65%;
}

#twsyuagdcb .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#twsyuagdcb .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#twsyuagdcb .gt_indent_1 {
  text-indent: 5px;
}

#twsyuagdcb .gt_indent_2 {
  text-indent: 10px;
}

#twsyuagdcb .gt_indent_3 {
  text-indent: 15px;
}

#twsyuagdcb .gt_indent_4 {
  text-indent: 20px;
}

#twsyuagdcb .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="gt_col_headings">
<th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="<strong>Characteristic</strong>"><strong>Characteristic</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>2017</strong>, N = 314<span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>">
<strong>2017</strong>, N = 314<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span>
</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>2018</strong>, N = 456<span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>">
<strong>2018</strong>, N = 456<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span>
</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>2019</strong>, N = 260<span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>">
<strong>2019</strong>, N = 260<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span>
</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>2020</strong>, N = 262<span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>">
<strong>2020</strong>, N = 262<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span>
</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>2021</strong>, N = 496<span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>">
<strong>2021</strong>, N = 496<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span>
</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>2022</strong>, N = 166<span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>">
<strong>2022</strong>, N = 166<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span>
</th>
    </tr></thead>
<tbody class="gt_table_body">
<tr>
<td headers="label" class="gt_row gt_left">variable</td>
<td headers="stat_1" class="gt_row gt_center"></td>
<td headers="stat_2" class="gt_row gt_center"></td>
<td headers="stat_3" class="gt_row gt_center"></td>
<td headers="stat_4" class="gt_row gt_center"></td>
<td headers="stat_5" class="gt_row gt_center"></td>
<td headers="stat_6" class="gt_row gt_center"></td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;averageGradesMeritRating9thGrade</td>
<td headers="stat_1" class="gt_row gt_center">21 (6.7%)</td>
<td headers="stat_2" class="gt_row gt_center">22 (4.8%)</td>
<td headers="stat_3" class="gt_row gt_center">22 (8.5%)</td>
<td headers="stat_4" class="gt_row gt_center">21 (8.0%)</td>
<td headers="stat_5" class="gt_row gt_center">23 (4.6%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;averageResultNationalTestsSubjectENG6thGrade</td>
<td headers="stat_1" class="gt_row gt_center">26 (8.3%)</td>
<td headers="stat_2" class="gt_row gt_center">26 (5.7%)</td>
<td headers="stat_3" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_4" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_5" class="gt_row gt_center">26 (5.2%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;averageResultNationalTestsSubjectENG9thGrade</td>
<td headers="stat_1" class="gt_row gt_center">21 (6.7%)</td>
<td headers="stat_2" class="gt_row gt_center">22 (4.8%)</td>
<td headers="stat_3" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_4" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_5" class="gt_row gt_center">23 (4.6%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;averageResultNationalTestsSubjectMA6thGrade</td>
<td headers="stat_1" class="gt_row gt_center">26 (8.3%)</td>
<td headers="stat_2" class="gt_row gt_center">26 (5.7%)</td>
<td headers="stat_3" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_4" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_5" class="gt_row gt_center">26 (5.2%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;averageResultNationalTestsSubjectMA9thGrade</td>
<td headers="stat_1" class="gt_row gt_center">21 (6.7%)</td>
<td headers="stat_2" class="gt_row gt_center">22 (4.8%)</td>
<td headers="stat_3" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_4" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_5" class="gt_row gt_center">23 (4.6%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;averageResultNationalTestsSubjectSVA6thGrade</td>
<td headers="stat_1" class="gt_row gt_center">26 (8.3%)</td>
<td headers="stat_2" class="gt_row gt_center">26 (5.7%)</td>
<td headers="stat_3" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_4" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_5" class="gt_row gt_center">26 (5.2%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;averageResultNationalTestsSubjectSVA9thGrade</td>
<td headers="stat_1" class="gt_row gt_center">21 (6.7%)</td>
<td headers="stat_2" class="gt_row gt_center">22 (4.8%)</td>
<td headers="stat_3" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_4" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_5" class="gt_row gt_center">23 (4.6%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;averageResultNationalTestsSubjectSVE6thGrade</td>
<td headers="stat_1" class="gt_row gt_center">26 (8.3%)</td>
<td headers="stat_2" class="gt_row gt_center">26 (5.7%)</td>
<td headers="stat_3" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_4" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_5" class="gt_row gt_center">26 (5.2%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;averageResultNationalTestsSubjectSVE9thGrade</td>
<td headers="stat_1" class="gt_row gt_center">21 (6.7%)</td>
<td headers="stat_2" class="gt_row gt_center">22 (4.8%)</td>
<td headers="stat_3" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_4" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_5" class="gt_row gt_center">23 (4.6%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;certifiedTeachersQuota</td>
<td headers="stat_1" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_2" class="gt_row gt_center">33 (7.2%)</td>
<td headers="stat_3" class="gt_row gt_center">32 (12%)</td>
<td headers="stat_4" class="gt_row gt_center">34 (13%)</td>
<td headers="stat_5" class="gt_row gt_center">34 (6.9%)</td>
<td headers="stat_6" class="gt_row gt_center">33 (20%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;ratioOfPupils9thGradeEligibleForNationalProgramES</td>
<td headers="stat_1" class="gt_row gt_center">21 (6.7%)</td>
<td headers="stat_2" class="gt_row gt_center">22 (4.8%)</td>
<td headers="stat_3" class="gt_row gt_center">22 (8.5%)</td>
<td headers="stat_4" class="gt_row gt_center">21 (8.0%)</td>
<td headers="stat_5" class="gt_row gt_center">23 (4.6%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;ratioOfPupils9thGradeEligibleForNationalProgramNATE</td>
<td headers="stat_1" class="gt_row gt_center">21 (6.7%)</td>
<td headers="stat_2" class="gt_row gt_center">22 (4.8%)</td>
<td headers="stat_3" class="gt_row gt_center">22 (8.5%)</td>
<td headers="stat_4" class="gt_row gt_center">21 (8.0%)</td>
<td headers="stat_5" class="gt_row gt_center">23 (4.6%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;ratioOfPupils9thGradeEligibleForNationalProgramSAEKHU</td>
<td headers="stat_1" class="gt_row gt_center">21 (6.7%)</td>
<td headers="stat_2" class="gt_row gt_center">22 (4.8%)</td>
<td headers="stat_3" class="gt_row gt_center">22 (8.5%)</td>
<td headers="stat_4" class="gt_row gt_center">21 (8.0%)</td>
<td headers="stat_5" class="gt_row gt_center">23 (4.6%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;ratioOfPupils9thGradeEligibleForNationalProgramYR</td>
<td headers="stat_1" class="gt_row gt_center">21 (6.7%)</td>
<td headers="stat_2" class="gt_row gt_center">22 (4.8%)</td>
<td headers="stat_3" class="gt_row gt_center">22 (8.5%)</td>
<td headers="stat_4" class="gt_row gt_center">21 (8.0%)</td>
<td headers="stat_5" class="gt_row gt_center">23 (4.6%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;ratioOfPupilsIn6thGradeWithAllSubjectsPassed</td>
<td headers="stat_1" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_2" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_3" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_4" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_5" class="gt_row gt_center">26 (5.2%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;ratioOfPupilsIn9thGradeWithAllSubjectsPassed</td>
<td headers="stat_1" class="gt_row gt_center">21 (6.7%)</td>
<td headers="stat_2" class="gt_row gt_center">22 (4.8%)</td>
<td headers="stat_3" class="gt_row gt_center">22 (8.5%)</td>
<td headers="stat_4" class="gt_row gt_center">21 (8.0%)</td>
<td headers="stat_5" class="gt_row gt_center">23 (4.6%)</td>
<td headers="stat_6" class="gt_row gt_center">0 (0%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;specialEducatorsQuota</td>
<td headers="stat_1" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_2" class="gt_row gt_center">33 (7.2%)</td>
<td headers="stat_3" class="gt_row gt_center">32 (12%)</td>
<td headers="stat_4" class="gt_row gt_center">34 (13%)</td>
<td headers="stat_5" class="gt_row gt_center">34 (6.9%)</td>
<td headers="stat_6" class="gt_row gt_center">33 (20%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;specialTeacherPositions</td>
<td headers="stat_1" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_2" class="gt_row gt_center">33 (7.2%)</td>
<td headers="stat_3" class="gt_row gt_center">32 (12%)</td>
<td headers="stat_4" class="gt_row gt_center">34 (13%)</td>
<td headers="stat_5" class="gt_row gt_center">34 (6.9%)</td>
<td headers="stat_6" class="gt_row gt_center">33 (20%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;studentsPerTeacherQuota</td>
<td headers="stat_1" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_2" class="gt_row gt_center">33 (7.2%)</td>
<td headers="stat_3" class="gt_row gt_center">32 (12%)</td>
<td headers="stat_4" class="gt_row gt_center">34 (13%)</td>
<td headers="stat_5" class="gt_row gt_center">34 (6.9%)</td>
<td headers="stat_6" class="gt_row gt_center">33 (20%)</td>
</tr>
<tr>
<td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;totalNumberOfPupils</td>
<td headers="stat_1" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_2" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_3" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_4" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_5" class="gt_row gt_center">0 (0%)</td>
<td headers="stat_6" class="gt_row gt_center">34 (20%)</td>
</tr>
</tbody>
<tfoot class="gt_footnotes"><tr>
<td class="gt_footnote" colspan="7">
<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span> n (%)</td>
    </tr></tfoot>
</table>
</div>
</div>
</div>
</section><section id="number-of-pupils-per-school" class="level3" data-number="5.2"><h3 data-number="5.2" class="anchored" data-anchor-id="number-of-pupils-per-school">
<span class="header-section-number">5.2</span> Number of pupils per school</h3>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-47_274a76c214773cf540c371187b23d1d4">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df.gr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="st">"totalNumberOfPupils"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">timePeriod</span><span class="op">)</span>, </span>
<span>             y <span class="op">=</span> <span class="va">value</span>, </span>
<span>             color <span class="op">=</span> <span class="va">Skolenhetsnamn</span>,</span>
<span>             group <span class="op">=</span> <span class="va">Skolenhetsnamn</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="skolverketapi_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="1050"></p>
</div>
</div>
<p>Only data from 2022 for that variable. We need to look elsewhere for historical data, it seems. It would also be useful to have the number of pupils per class, since we want to make comparisons to survey data responses. However, the documentation of this variable indicates that number of pupils is rounded to nearest 10th:</p>
<blockquote class="blockquote">
<p>“Antal elever på skolenheten, avrundat till tiotal. 1-14 elever ger 10, 15-24 elever ger 20, 25-34 elever ger 30, enkelprick förekommer om elever saknas. Uppgiften samlas in 15 oktober varje år och uppdatering sker i mars året efter insamling.”</p>
</blockquote>
<p>Also, we can see that there are several school units that have very similar names, or represent parts of the same schools. This data is clearly quite complex in its structure.</p>
<p>As a bonus item, here is a more suitable type of figure to illustrate data from a single year,</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-48_40ff4c78400d36c13963480a39e0cf21">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df.gr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="st">"totalNumberOfPupils"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Skolenhetsnamn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Skolenhetsnamn</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op">(</span><span class="va">Skolenhetsnamn</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             y <span class="op">=</span> <span class="va">value</span>,</span>
<span>             fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Number of pupils"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="skolverketapi_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid" width="1050"></p>
</div>
</div>
</section><section id="studentsperteacherquota" class="level3" data-number="5.3"><h3 data-number="5.3" class="anchored" data-anchor-id="studentsperteacherquota">
<span class="header-section-number">5.3</span> studentsPerTeacherQuota</h3>
<p>Here we have data from multiple school years.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-49_1ae770e754cba4c5e2d4eed547447a0a">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df.gr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="st">"studentsPerTeacherQuota"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">timePeriod</span><span class="op">)</span>, </span>
<span>             y <span class="op">=</span> <span class="va">value</span>, </span>
<span>             color <span class="op">=</span> <span class="va">Skolenhetsnamn</span>,</span>
<span>             group <span class="op">=</span> <span class="va">Skolenhetsnamn</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="skolverketapi_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="1050"></p>
</div>
</div>
<p>Huge variation, probably since there are schools in the data that seem to represent special education groups. Let’s look at the average numbers across years and sort out the 10 with the lowest number of pupils per teacher.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-50_451f63de3161aae527e2dfc44d3833f4">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df.gr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="st">"studentsPerTeacherQuota"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Skolenhetsnamn</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span>Average <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">Average</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   Skolenhetsnamn                  Average
   &lt;chr&gt;                             &lt;dbl&gt;
 1 Rikstens skola Trampolinen 1GR     3.88
 2 Storvretskolan 1GR                 5.34
 3 Borgsskolan Borggruppen 1GR        5.78
 4 Hammerstaskolan Språkenhet 1GR     5.82
 5 Fittjaskolan Lilla Aspen 1GR       6   
 6 Falkbergsskolan klass 6-9 A 1GR    7.08
 7 Freinetskolan Kastanjen            9.66
 8 Sverigefinska skolan, Botkyrka    10   
 9 Storvretskolan                    11.3 
10 Hammerstaskolan                   11.5 </code></pre>
</div>
</div>
<p>We’ll remove the ones with “1GR” at the end of the school name.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-51_f86a56f328c09907aa64037302086215">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df.gr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="st">"studentsPerTeacherQuota"</span>,</span>
<span>         <span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">Skolenhetsnamn</span>,<span class="st">"1GR"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">timePeriod</span><span class="op">)</span>, </span>
<span>             y <span class="op">=</span> <span class="va">value</span>, </span>
<span>             color <span class="op">=</span> <span class="va">Skolenhetsnamn</span></span>
<span>             <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">Skolenhetsnamn</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="skolverketapi_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="1050"></p>
</div>
</div>
<p>Let’s update our information about the schools with some more variables. This will get a bit complicated since an API call for a school unit that has more than one type will contain strings for some variables instead of single values. Also, the <code>schoolYear</code> variable is a string in itself, so we need to get the first and last value from that and combine into one value.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-52_9faeee97608e6b692ee7b1072859d180">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schoolUnitCodes</span> <span class="op">&lt;-</span> <span class="va">schoolTypes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"gr"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">Skolenhetskod</span><span class="op">)</span></span>
<span></span>
<span><span class="va">schoolTypes2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># making a new dataframe, to avoid overwriting the old one when we test things</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">schoolUnitCodes</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="st">"text"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">code</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span> <span class="co"># if both fsk and gr</span></span>
<span>  </span>
<span>    <span class="va">tmp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">code</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    principalOrganizerType <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">principalOrganizerType</span>,</span>
<span>    companyForm <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">companyForm</span>,</span>
<span>    schoolYears <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">schoolYears</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="st">"-"</span>,<span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">schoolYears</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">schoolYears</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    corporationName <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">corporationName</span>,</span>
<span>    latitude <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">wgs84_Lat</span>,</span>
<span>    longitude <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">wgs84_Long</span>,</span>
<span>    zipCode <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">contactInfo</span><span class="op">$</span><span class="va">addresses</span><span class="op">$</span><span class="va">zipCode</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    Skolenhetskod <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>                     </span>
<span>  <span class="va">schoolTypes2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">schoolTypes2</span>,<span class="va">tmp2</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="co"># when schoolType only "gr"</span></span>
<span>    <span class="va">tmp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">code</span>,</span>
<span>    principalOrganizerType <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">principalOrganizerType</span>,</span>
<span>    companyForm <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">companyForm</span>,</span>
<span>    schoolYears <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">schoolYears</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="st">"-"</span>,<span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">schoolYears</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">typeOfSchooling</span><span class="op">$</span><span class="va">schoolYears</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    corporationName <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">corporationName</span>,</span>
<span>    latitude <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">wgs84_Lat</span>,</span>
<span>    longitude <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">wgs84_Long</span>,</span>
<span>    zipCode <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">body</span><span class="op">$</span><span class="va">contactInfo</span><span class="op">$</span><span class="va">addresses</span><span class="op">$</span><span class="va">zipCode</span>,</span>
<span>    Skolenhetskod <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>                     </span>
<span>  <span class="va">schoolTypes2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">schoolTypes2</span>,<span class="va">tmp2</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">schoolTypes2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">schoolTypes2</span>,<span class="va">schools</span>, by <span class="op">=</span> <span class="st">"Skolenhetskod"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">schoolTypes2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 41
Columns: 13
$ type                   &lt;chr&gt; "gr", "gr", "gr", "gr", "gr", "gr", "gr", "gr",…
$ principalOrganizerType &lt;chr&gt; "Fristående", "Fristående", "Fristående", "Fris…
$ companyForm            &lt;chr&gt; "Övriga aktiebolag", "Övriga aktiebolag", "Övri…
$ schoolYears            &lt;chr&gt; "4-9", "4-9", "1-6", "1-9", "1-9", "6-9", "6-9"…
$ corporationName        &lt;chr&gt; "Kunskapsskolan i Sverige Aktiebolag", "Kunskap…
$ latitude               &lt;chr&gt; "59.20011169538554", "59.20011169538554", "59.2…
$ longitude              &lt;chr&gt; "17.846722627859616", "17.846722627859616", "17…
$ zipCode                &lt;chr&gt; "14741", "14741", "14568", "14574", "14740", "1…
$ Skolenhetskod          &lt;chr&gt; "84411355", "84411355", "16762245", "29524966",…
$ Kommunkod              &lt;chr&gt; "0127", "0127", "0127", "0127", "0127", "0127",…
$ PeOrgNr                &lt;chr&gt; "5565661815", "5565661815", "8024242391", "7696…
$ Skolenhetsnamn         &lt;chr&gt; "Kunskapsskolan Tumba", "Kunskapsskolan Tumba",…
$ Status                 &lt;chr&gt; "Aktiv", "Aktiv", "Aktiv", "Aktiv", "Aktiv", "A…</code></pre>
</div>
</div>
<p>Well, that was a handful to work out. And we only get “gr” schools, so a similar process will be necessary if we want to get the other school types. It should at least be a lot quicker since we have worked out some solutions already, depending on the differences in data structure.</p>
</section></section><section id="more-demographics" class="level2" data-number="6"><h2 data-number="6" class="anchored" data-anchor-id="more-demographics">
<span class="header-section-number">6</span> More demographics</h2>
<p>It seems that there are other types of data available for manual download that I am unable to find using the API documentation and exploration. I emailed Skolverket and asked them if it is possible to retrieve this data via API, and while waiting for a response I manually downloaded the files and combined them. The website URL for manual downloads is <a href="https://www.skolverket.se/skolutveckling/statistik/sok-statistik-om-forskola-skola-och-vuxenutbildning?sok=SokD&amp;niva=S&amp;omr=elever&amp;exp=6&amp;lasar=2022&amp;uttag=null">here</a></p>
<p>I’ve limited this example to the last five years, thus five files.</p>
<p>First, let’s read one file. I’ve already done some exploring here, which resulted in skipping the first five rows (which contains what should be meta-data basically) and using semi-colon for separation of data fields. Also, the amazing <code><a href="https://sfirke.github.io/janitor/reference/clean_names.html">janitor::clean_names()</a></code> is used, an empty variable is removed, and a year variable is added.</p>
<p>Specifying “.” and “..” as missing data indicators would seem accurate, but doing this when importing data screws up decimal points later, so we need a manual recode after import.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-53_1dca55744cb204af4ab1d6ced0255f5c">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-forge.r-project.org/projects/car/">car</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_delim</a></span><span class="op">(</span><span class="st">"data/Grundskolan - Antal elever per årskurs 2022 Skolenhet.csv"</span>,</span>
<span>                 skip <span class="op">=</span> <span class="fl">5</span>, delim <span class="op">=</span> <span class="st">";"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="va">x23</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html">add_column</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,740
Columns: 23
$ skola                                                            &lt;chr&gt; "Ahla…
$ skol_enhetskod                                                   &lt;dbl&gt; 71387…
$ skolkommun                                                       &lt;chr&gt; "Ale"…
$ kommun_kod                                                       &lt;chr&gt; "1440…
$ typ_av_huvudman                                                  &lt;chr&gt; "Ensk…
$ huvudman                                                         &lt;chr&gt; "Ahla…
$ huvudman_orgnr                                                   &lt;dbl&gt; 76961…
$ elever_forskoleklass                                             &lt;chr&gt; "22",…
$ andel_percent_flickor_forskoleklass                              &lt;chr&gt; "..",…
$ elever_arskurs_1_9                                               &lt;chr&gt; "258"…
$ andel_percent_flickor_arskurs_1_9                                &lt;chr&gt; "48,4…
$ andel_percent_elever_med_utlandsk_bakgrund_ak_1_9                &lt;chr&gt; "4,7"…
$ andel_percent_elever_med_foraldrar_med_eftergymnasial_utb_ak_1_9 &lt;chr&gt; "69,8…
$ elever_arskurs_1                                                 &lt;chr&gt; "24",…
$ elever_arskurs_2                                                 &lt;chr&gt; "22",…
$ elever_arskurs_3                                                 &lt;chr&gt; "22",…
$ elever_arskurs_4                                                 &lt;chr&gt; "25",…
$ elever_arskurs_5                                                 &lt;chr&gt; "49",…
$ elever_arskurs_6                                                 &lt;chr&gt; "23",…
$ elever_arskurs_7                                                 &lt;chr&gt; "24",…
$ elever_arskurs_8                                                 &lt;chr&gt; "46",…
$ elever_arskurs_9                                                 &lt;chr&gt; "23",…
$ year                                                             &lt;dbl&gt; 2022,…</code></pre>
</div>
</div>
<p>Some recodings are in order.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-54_86074c5ce871b1690f02c3f0210b9175">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_delim</a></span><span class="op">(</span><span class="st">"data/Grundskolan - Antal elever per årskurs 2022 Skolenhet.csv"</span>,</span>
<span>                 skip <span class="op">=</span> <span class="fl">5</span>, delim <span class="op">=</span> <span class="st">";"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="va">x23</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html">add_column</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">elever_forskoleklass</span><span class="op">:</span><span class="va">elever_arskurs_9</span>, <span class="op">~</span> <span class="fu">car</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/car/man/recode.html">recode</a></span><span class="op">(</span><span class="va">.x</span>,<span class="st">"'.'=NA;'..'=NA"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"andel"</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">","</span>,<span class="st">"."</span>,<span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"andel"</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>elever_arskurs_1_9 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">elever_arskurs_1_9</span><span class="op">)</span>,</span>
<span>           skol_enhetskod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">skol_enhetskod</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,740
Columns: 23
$ skola                                                            &lt;chr&gt; "Ahla…
$ skol_enhetskod                                                   &lt;dbl&gt; 71387…
$ skolkommun                                                       &lt;chr&gt; "Ale"…
$ kommun_kod                                                       &lt;chr&gt; "1440…
$ typ_av_huvudman                                                  &lt;chr&gt; "Ensk…
$ huvudman                                                         &lt;chr&gt; "Ahla…
$ huvudman_orgnr                                                   &lt;dbl&gt; 76961…
$ elever_forskoleklass                                             &lt;dbl&gt; 22, N…
$ andel_percent_flickor_forskoleklass                              &lt;dbl&gt; NA, N…
$ elever_arskurs_1_9                                               &lt;dbl&gt; 258, …
$ andel_percent_flickor_arskurs_1_9                                &lt;dbl&gt; 48.4,…
$ andel_percent_elever_med_utlandsk_bakgrund_ak_1_9                &lt;dbl&gt; 4.7, …
$ andel_percent_elever_med_foraldrar_med_eftergymnasial_utb_ak_1_9 &lt;dbl&gt; 69.8,…
$ elever_arskurs_1                                                 &lt;dbl&gt; 24, N…
$ elever_arskurs_2                                                 &lt;dbl&gt; 22, N…
$ elever_arskurs_3                                                 &lt;dbl&gt; 22, N…
$ elever_arskurs_4                                                 &lt;dbl&gt; 25, 6…
$ elever_arskurs_5                                                 &lt;dbl&gt; 49, 6…
$ elever_arskurs_6                                                 &lt;dbl&gt; 23, 5…
$ elever_arskurs_7                                                 &lt;dbl&gt; 24, N…
$ elever_arskurs_8                                                 &lt;dbl&gt; 46, N…
$ elever_arskurs_9                                                 &lt;dbl&gt; 23, N…
$ year                                                             &lt;dbl&gt; 2022,…</code></pre>
</div>
</div>
<p>And now, putting all files into the same dataframe.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-55_9084411fb46d79a59187b0716954a24e">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># get all filenames in the folder</span></span>
<span><span class="va">fileList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"data/"</span>, full.names<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2018</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span></span>
<span><span class="co"># create an empty list to store data in</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># loop over filenames to import them to the list object</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">fileList</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_delim</a></span><span class="op">(</span><span class="va">fileList</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                 skip <span class="op">=</span> <span class="fl">5</span>, delim <span class="op">=</span> <span class="st">";"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="va">x23</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html">add_column</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">years</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">elever_forskoleklass</span><span class="op">:</span><span class="va">elever_arskurs_9</span>, <span class="op">~</span> <span class="fu">car</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/car/man/recode.html">recode</a></span><span class="op">(</span><span class="va">.x</span>,<span class="st">"'.'=NA;'..'=NA"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"andel"</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">","</span>,<span class="st">"."</span>,<span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"andel"</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>elever_arskurs_1_9 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">elever_arskurs_1_9</span><span class="op">)</span>,</span>
<span>           skol_enhetskod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">skol_enhetskod</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">### Combine all nested lists into one dataframe</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">bind_rows</span>, <span class="va">data</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 24,027
Columns: 23
$ skola                                                            &lt;chr&gt; "Ahla…
$ skol_enhetskod                                                   &lt;dbl&gt; 71387…
$ skolkommun                                                       &lt;chr&gt; "Ale"…
$ kommun_kod                                                       &lt;chr&gt; "1440…
$ typ_av_huvudman                                                  &lt;chr&gt; "Ensk…
$ huvudman                                                         &lt;chr&gt; "Ahla…
$ huvudman_orgnr                                                   &lt;dbl&gt; 76961…
$ elever_forskoleklass                                             &lt;dbl&gt; 22, N…
$ andel_percent_flickor_forskoleklass                              &lt;dbl&gt; NA, N…
$ elever_arskurs_1_9                                               &lt;dbl&gt; 244, …
$ andel_percent_flickor_arskurs_1_9                                &lt;dbl&gt; 51, 4…
$ andel_percent_elever_med_utlandsk_bakgrund_ak_1_9                &lt;dbl&gt; NA, 9…
$ andel_percent_elever_med_foraldrar_med_eftergymnasial_utb_ak_1_9 &lt;dbl&gt; 64, 4…
$ elever_arskurs_1                                                 &lt;dbl&gt; 22, N…
$ elever_arskurs_2                                                 &lt;dbl&gt; 22, N…
$ elever_arskurs_3                                                 &lt;dbl&gt; 22, N…
$ elever_arskurs_4                                                 &lt;dbl&gt; 44, 5…
$ elever_arskurs_5                                                 &lt;dbl&gt; 20, 4…
$ elever_arskurs_6                                                 &lt;dbl&gt; 21, 6…
$ elever_arskurs_7                                                 &lt;dbl&gt; 44, N…
$ elever_arskurs_8                                                 &lt;dbl&gt; 24, N…
$ elever_arskurs_9                                                 &lt;dbl&gt; 25, N…
$ year                                                             &lt;int&gt; 2018,…</code></pre>
</div>
</div>
<p>There we go. And now we can write to a compressed file if we want to.</p>
<div class="cell" data-hash="skolverketapi_cache/html/unnamed-chunk-56_b46cf5fe5a643619e4f7c6dce809071b">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="va">df</span>,<span class="st">"SkolverketData.parquet"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->

</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb95" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Data retrieval with R using API calls"</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "The Swedish National Agency for Education database API"</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: 'Magnus Johansson'</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: 'RISE Research Institutes of Sweden'</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation-url: 'https://ri.se/shic'</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid: '0000-0003-1669-592X'</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: 'Jens Mattsson'</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: 'RISE Research Institutes of Sweden'</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation-url: 'https://ri.se/shic'</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> last-modified</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a><span class="an">date-format:</span><span class="co"> iso</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a><span class="co">    css: api-styles.css</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a><span class="co">  cache: true</span></span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a><span class="fu">## Background</span></span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>This is a post documenting explorative work to retrieve data using the <span class="co">[</span><span class="ot">database API</span><span class="co">](https://www.skolverket.se/om-oss/oppna-data/api-for-skolenhetsregistret)</span> maintained Swedish National Agency for Education. The conditions for using the API and database are described in the <span class="co">[</span><span class="ot">CC0 1.0 license</span><span class="co">](https://creativecommons.org/publicdomain/zero/1.0/deed.en)</span>. The API is documented here: <span class="ot">&lt;https://api.skolverket.se/skolenhetsregistret/swagger-ui/index.html&gt;</span>.</span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a><span class="fu">### Note</span></span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a>Please note that this is just documentation of our work, not a guide. There will be mistakes and suboptimal routes taken. But in the end I hope we will produce something that may be useful to others. Not everyone will be interested in using the API for the same purpose as we had, so hopefully our troubleshooting will make the potential use wider.</span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a>A lot of the output will be in Swedish, but you will probably be able to follow along even if your Swedish knowledge is limited. Basic word list:</span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>school = skola</span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>school unit code = Skolenhetskod</span>
<span id="cb95-38"><a href="#cb95-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-39"><a href="#cb95-39" aria-hidden="true" tabindex="-1"></a>The purpose of this is two-fold. First, various kinds of data on school and municipality levels are of interest in the project <span class="co">[</span><span class="ot">"Data in dialogue"</span><span class="co">](https://www.ri.se/en/what-we-do/projects/data-in-dialogue-risk-and-protective-factors-for-children-and-youth)</span>. Second, in order to conduct analysis of missing data and selection bias we need demographic data about students at the schools participating in school surveys that are used to assess risk and protective factors.</span>
<span id="cb95-40"><a href="#cb95-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-41"><a href="#cb95-41" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb95-42"><a href="#cb95-42" aria-hidden="true" tabindex="-1"></a><span class="fu">### Note</span></span>
<span id="cb95-43"><a href="#cb95-43" aria-hidden="true" tabindex="-1"></a>While this blog post is written by me (Magnus), a lot of the initial trial and error work was done by my colleague Jens Mattsson.</span>
<span id="cb95-44"><a href="#cb95-44" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb95-45"><a href="#cb95-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-46"><a href="#cb95-46" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting up</span></span>
<span id="cb95-47"><a href="#cb95-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-50"><a href="#cb95-50" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-51"><a href="#cb95-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb95-52"><a href="#cb95-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arrow)</span>
<span id="cb95-53"><a href="#cb95-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb95-54"><a href="#cb95-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rjson)</span>
<span id="cb95-55"><a href="#cb95-55" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb95-56"><a href="#cb95-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb95-57"><a href="#cb95-57" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-58"><a href="#cb95-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-59"><a href="#cb95-59" aria-hidden="true" tabindex="-1"></a>First, let's get a list of municipalities and their codes. The first two numbers in the four number code denotes the region. Sweden has 290 municipalities and 21 regions. For this project, we are interested in the regions of Stockholm and Uppsala, which have codes 01 and 03.</span>
<span id="cb95-60"><a href="#cb95-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-63"><a href="#cb95-63" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-64"><a href="#cb95-64" aria-hidden="true" tabindex="-1"></a>municipalities <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(<span class="st">"2023-03-28_KOLADA_Municipality_list.parquet"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-65"><a href="#cb95-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(id, <span class="st">"^01|^03"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb95-66"><a href="#cb95-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span>type)</span>
<span id="cb95-67"><a href="#cb95-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-68"><a href="#cb95-68" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(municipalities)</span>
<span id="cb95-69"><a href="#cb95-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-70"><a href="#cb95-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-71"><a href="#cb95-71" aria-hidden="true" tabindex="-1"></a><span class="fu">## Getting data for one municipality</span></span>
<span id="cb95-72"><a href="#cb95-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-73"><a href="#cb95-73" aria-hidden="true" tabindex="-1"></a>Looking at the specifications of the API, we should be able to get all schools in a municipality by doing a call according to <span class="in">`/v1/kommun/{municipalityCode}`</span>. Unfortunately, the API does not seem to allow making one call for multiple municipalities. The base URL is <span class="in">`https://api.skolverket.se/skolenhetsregistret`</span>.</span>
<span id="cb95-74"><a href="#cb95-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-75"><a href="#cb95-75" aria-hidden="true" tabindex="-1"></a>We'll start by getting data from one municipality.</span>
<span id="cb95-76"><a href="#cb95-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-79"><a href="#cb95-79" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-80"><a href="#cb95-80" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="st">"https://api.skolverket.se/skolenhetsregistret/v1/kommun/0127"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-81"><a href="#cb95-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">content</span>(<span class="st">"text"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-82"><a href="#cb95-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fromJSON</span>()</span>
<span id="cb95-83"><a href="#cb95-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-84"><a href="#cb95-84" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(data)</span>
<span id="cb95-85"><a href="#cb95-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-86"><a href="#cb95-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-87"><a href="#cb95-87" aria-hidden="true" tabindex="-1"></a>We get a list of 3, where the data of interest seems to be within the nested dataframe <span class="in">`$Skolenheter`</span>. Let's subset that into its own dataframe object.</span>
<span id="cb95-88"><a href="#cb95-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-91"><a href="#cb95-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-92"><a href="#cb95-92" aria-hidden="true" tabindex="-1"></a>schools <span class="ot">&lt;-</span> data<span class="sc">$</span>Skolenheter</span>
<span id="cb95-93"><a href="#cb95-93" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(schools)</span>
<span id="cb95-94"><a href="#cb95-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-95"><a href="#cb95-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-96"><a href="#cb95-96" aria-hidden="true" tabindex="-1"></a>Now, this is just a list of schools and their unit codes (<span class="in">`schools$Skolenhetskod`</span>), it contains no data. But we need this list to know which school unit codes to retrieve data for. There is also a <span class="in">`Status`</span> variable which seems to have the options of active or not.</span>
<span id="cb95-97"><a href="#cb95-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-100"><a href="#cb95-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-101"><a href="#cb95-101" aria-hidden="true" tabindex="-1"></a>schools <span class="sc">%&gt;%</span> </span>
<span id="cb95-102"><a href="#cb95-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(Status)</span>
<span id="cb95-103"><a href="#cb95-103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-104"><a href="#cb95-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-105"><a href="#cb95-105" aria-hidden="true" tabindex="-1"></a>There was also a third option for "planned". Not sure how to use this information at this point.</span>
<span id="cb95-106"><a href="#cb95-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-107"><a href="#cb95-107" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data from one school</span></span>
<span id="cb95-108"><a href="#cb95-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-109"><a href="#cb95-109" aria-hidden="true" tabindex="-1"></a>We'll retrieve data for one school first.</span>
<span id="cb95-110"><a href="#cb95-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-113"><a href="#cb95-113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-114"><a href="#cb95-114" aria-hidden="true" tabindex="-1"></a>sdata <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="st">"https://api.skolverket.se/skolenhetsregistret/v1/skolenhet/84411355"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-115"><a href="#cb95-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">content</span>(<span class="st">"text"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-116"><a href="#cb95-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fromJSON</span>()</span>
<span id="cb95-117"><a href="#cb95-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-118"><a href="#cb95-118" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(sdata)</span>
<span id="cb95-119"><a href="#cb95-119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-120"><a href="#cb95-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-121"><a href="#cb95-121" aria-hidden="true" tabindex="-1"></a>This provides a lot of information about the school itself, which can be useful. There is also a version 3 of the API, which contains more information:</span>
<span id="cb95-122"><a href="#cb95-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-125"><a href="#cb95-125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-126"><a href="#cb95-126" aria-hidden="true" tabindex="-1"></a>sdataV3 <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/84411355"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-127"><a href="#cb95-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">content</span>(<span class="st">"text"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-128"><a href="#cb95-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fromJSON</span>()</span>
<span id="cb95-129"><a href="#cb95-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-130"><a href="#cb95-130" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(sdataV3)</span>
<span id="cb95-131"><a href="#cb95-131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-132"><a href="#cb95-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-133"><a href="#cb95-133" aria-hidden="true" tabindex="-1"></a>Can we find statistics for the school?</span>
<span id="cb95-134"><a href="#cb95-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-137"><a href="#cb95-137" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-138"><a href="#cb95-138" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/84411355/statistics"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-139"><a href="#cb95-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">content</span>(<span class="st">"text"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-140"><a href="#cb95-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fromJSON</span>()</span>
<span id="cb95-141"><a href="#cb95-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-142"><a href="#cb95-142" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(test)</span>
<span id="cb95-143"><a href="#cb95-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-144"><a href="#cb95-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-145"><a href="#cb95-145" aria-hidden="true" tabindex="-1"></a>No data, but some clues:</span>
<span id="cb95-146"><a href="#cb95-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-149"><a href="#cb95-149" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-150"><a href="#cb95-150" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>body<span class="sc">$</span><span class="st">`</span><span class="at">_links</span><span class="st">`</span><span class="sc">$</span><span class="st">`</span><span class="at">gr-statistics</span><span class="st">`</span></span>
<span id="cb95-151"><a href="#cb95-151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-152"><a href="#cb95-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-153"><a href="#cb95-153" aria-hidden="true" tabindex="-1"></a>We'll try that URL.</span>
<span id="cb95-154"><a href="#cb95-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-157"><a href="#cb95-157" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-158"><a href="#cb95-158" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/84411355/statistics/gr"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-159"><a href="#cb95-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">content</span>(<span class="st">"text"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-160"><a href="#cb95-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fromJSON</span>()</span>
<span id="cb95-161"><a href="#cb95-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-162"><a href="#cb95-162" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(test)</span>
<span id="cb95-163"><a href="#cb95-163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-164"><a href="#cb95-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-165"><a href="#cb95-165" aria-hidden="true" tabindex="-1"></a>It seems like we need to specify the type of school to retrieve the stats. In this case, "gr" for "grundskola", which corresponds to classes 1-9 in Sweden (ages ~ 7-15).</span>
<span id="cb95-166"><a href="#cb95-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-167"><a href="#cb95-167" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data wrangling</span></span>
<span id="cb95-168"><a href="#cb95-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-169"><a href="#cb95-169" aria-hidden="true" tabindex="-1"></a>Some data wrangling will be needed to get the list() format data into a dataframe that can be used as a template for downloading and merging data for all schools we are interested in.</span>
<span id="cb95-170"><a href="#cb95-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-173"><a href="#cb95-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-174"><a href="#cb95-174" aria-hidden="true" tabindex="-1"></a>stats <span class="ot">&lt;-</span> test<span class="sc">$</span>body <span class="sc">%&gt;%</span> </span>
<span id="cb95-175"><a href="#cb95-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">"ratioOfPupils9thGradeEligibleForNationalProgramNATE"</span>)</span>
<span id="cb95-176"><a href="#cb95-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-177"><a href="#cb95-177" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-178"><a href="#cb95-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-179"><a href="#cb95-179" aria-hidden="true" tabindex="-1"></a>So that works to get one list out. Now let's do all that contain a variable named <span class="in">`value`</span> and get them in a single dataframe. A relatively simple way to do this (in the current data) is to filter the list elements that contain more than one value.</span>
<span id="cb95-180"><a href="#cb95-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-183"><a href="#cb95-183" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-184"><a href="#cb95-184" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">sapply</span>(test<span class="sc">$</span>body, <span class="cf">function</span>(x) <span class="fu">length</span>(x) <span class="sc">&gt;</span> <span class="dv">1</span>))</span>
<span id="cb95-185"><a href="#cb95-185" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(vars)</span>
<span id="cb95-186"><a href="#cb95-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-187"><a href="#cb95-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-188"><a href="#cb95-188" aria-hidden="true" tabindex="-1"></a>Then we can bind them together.</span>
<span id="cb95-189"><a href="#cb95-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-192"><a href="#cb95-192" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-193"><a href="#cb95-193" aria-hidden="true" tabindex="-1"></a><span class="co"># create empty dataframe to store output of loop in</span></span>
<span id="cb95-194"><a href="#cb95-194" aria-hidden="true" tabindex="-1"></a>df_total <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb95-195"><a href="#cb95-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-196"><a href="#cb95-196" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(vars)){</span>
<span id="cb95-197"><a href="#cb95-197" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> test<span class="sc">$</span>body <span class="sc">%&gt;%</span> </span>
<span id="cb95-198"><a href="#cb95-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(i) <span class="sc">%&gt;%</span> </span>
<span id="cb95-199"><a href="#cb95-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_column</span>(<span class="at">variable =</span> i)</span>
<span id="cb95-200"><a href="#cb95-200" aria-hidden="true" tabindex="-1"></a>  df_total <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df_total,tmp)</span>
<span id="cb95-201"><a href="#cb95-201" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-202"><a href="#cb95-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-203"><a href="#cb95-203" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(df_total)</span>
<span id="cb95-204"><a href="#cb95-204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-205"><a href="#cb95-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-206"><a href="#cb95-206" aria-hidden="true" tabindex="-1"></a>Looks good, although there will probably be a lot of recoding needed later.</span>
<span id="cb95-207"><a href="#cb95-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-208"><a href="#cb95-208" aria-hidden="true" tabindex="-1"></a><span class="fu">### Getting data from multiple schools</span></span>
<span id="cb95-209"><a href="#cb95-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-210"><a href="#cb95-210" aria-hidden="true" tabindex="-1"></a>Since the API demands that we specify the type of school in the API call, we need to add this information to the list of schools. This means that we first need to retrieve the basic information for each school.</span>
<span id="cb95-211"><a href="#cb95-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-214"><a href="#cb95-214" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-215"><a href="#cb95-215" aria-hidden="true" tabindex="-1"></a>sdataV3 <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/84411355"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-216"><a href="#cb95-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">content</span>(<span class="st">"text"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-217"><a href="#cb95-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fromJSON</span>()</span>
<span id="cb95-218"><a href="#cb95-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-219"><a href="#cb95-219" aria-hidden="true" tabindex="-1"></a>sdataV3<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>code</span>
<span id="cb95-220"><a href="#cb95-220" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-221"><a href="#cb95-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-222"><a href="#cb95-222" aria-hidden="true" tabindex="-1"></a>So that is where we find the type code for each school.</span>
<span id="cb95-223"><a href="#cb95-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-224"><a href="#cb95-224" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Check if all schools have data in the database.</span></span>
<span id="cb95-225"><a href="#cb95-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-228"><a href="#cb95-228" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-229"><a href="#cb95-229" aria-hidden="true" tabindex="-1"></a>schoolsAvailable <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb95-230"><a href="#cb95-230" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> schools<span class="sc">$</span>Skolenhetskod) {</span>
<span id="cb95-231"><a href="#cb95-231" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">http_status</span>(<span class="fu">GET</span>(<span class="fu">paste0</span>(<span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/"</span>, i))) <span class="sc">%&gt;%</span></span>
<span id="cb95-232"><a href="#cb95-232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="st">"reason"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb95-233"><a href="#cb95-233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>(<span class="at">nm =</span> <span class="st">"status"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb95-234"><a href="#cb95-234" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_column</span>(<span class="at">Skolenhetskod =</span> i)</span>
<span id="cb95-235"><a href="#cb95-235" aria-hidden="true" tabindex="-1"></a>  schoolsAvailable <span class="ot">&lt;-</span> <span class="fu">rbind</span>(schoolsAvailable, tmp)</span>
<span id="cb95-236"><a href="#cb95-236" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-237"><a href="#cb95-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-238"><a href="#cb95-238" aria-hidden="true" tabindex="-1"></a>schoolsAvailable <span class="sc">%&gt;%</span> </span>
<span id="cb95-239"><a href="#cb95-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(status)</span>
<span id="cb95-240"><a href="#cb95-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-241"><a href="#cb95-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-242"><a href="#cb95-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-243"><a href="#cb95-243" aria-hidden="true" tabindex="-1"></a>14 schools are not in the database and need to be removed from the list of schools before we retrieve data. Maybe they match up with the <span class="in">`Status`</span> variable?</span>
<span id="cb95-246"><a href="#cb95-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-247"><a href="#cb95-247" aria-hidden="true" tabindex="-1"></a>schools <span class="sc">%&gt;%</span> </span>
<span id="cb95-248"><a href="#cb95-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(.,schoolsAvailable, <span class="at">by =</span> <span class="st">"Skolenhetskod"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-249"><a href="#cb95-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>status <span class="sc">==</span> <span class="st">"OK"</span>)</span>
<span id="cb95-250"><a href="#cb95-250" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-251"><a href="#cb95-251" aria-hidden="true" tabindex="-1"></a>Indeed, but not a perfect match, since the numbers don't add up when compared to this:</span>
<span id="cb95-252"><a href="#cb95-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-255"><a href="#cb95-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-256"><a href="#cb95-256" aria-hidden="true" tabindex="-1"></a>schools <span class="sc">%&gt;%</span> </span>
<span id="cb95-257"><a href="#cb95-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(Status)</span>
<span id="cb95-258"><a href="#cb95-258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-259"><a href="#cb95-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-260"><a href="#cb95-260" aria-hidden="true" tabindex="-1"></a>Proceeding to remove schools unavailable in database.</span>
<span id="cb95-261"><a href="#cb95-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-264"><a href="#cb95-264" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-265"><a href="#cb95-265" aria-hidden="true" tabindex="-1"></a>schoolsFiltered <span class="ot">&lt;-</span> schools <span class="sc">%&gt;%</span> </span>
<span id="cb95-266"><a href="#cb95-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(.,schoolsAvailable, <span class="at">by =</span> <span class="st">"Skolenhetskod"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-267"><a href="#cb95-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(status <span class="sc">==</span> <span class="st">"OK"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-268"><a href="#cb95-268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span>status)</span>
<span id="cb95-269"><a href="#cb95-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-270"><a href="#cb95-270" aria-hidden="true" tabindex="-1"></a>schoolTypes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb95-271"><a href="#cb95-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-272"><a href="#cb95-272" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> schoolsFiltered<span class="sc">$</span>Skolenhetskod) {</span>
<span id="cb95-273"><a href="#cb95-273" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-274"><a href="#cb95-274" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="fu">paste0</span>(<span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/"</span>, i)) <span class="sc">%&gt;%</span> </span>
<span id="cb95-275"><a href="#cb95-275" aria-hidden="true" tabindex="-1"></a>    <span class="fu">content</span>(<span class="st">"text"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-276"><a href="#cb95-276" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fromJSON</span>()</span>
<span id="cb95-277"><a href="#cb95-277" aria-hidden="true" tabindex="-1"></a>  tmp2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb95-278"><a href="#cb95-278" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>code,</span>
<span id="cb95-279"><a href="#cb95-279" aria-hidden="true" tabindex="-1"></a>    <span class="at">Skolenhetskod =</span> i)</span>
<span id="cb95-280"><a href="#cb95-280" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb95-281"><a href="#cb95-281" aria-hidden="true" tabindex="-1"></a>  schoolTypes <span class="ot">&lt;-</span> <span class="fu">rbind</span>(schoolTypes,tmp2)</span>
<span id="cb95-282"><a href="#cb95-282" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-283"><a href="#cb95-283" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-284"><a href="#cb95-284" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(schoolTypes)</span>
<span id="cb95-285"><a href="#cb95-285" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-286"><a href="#cb95-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-287"><a href="#cb95-287" aria-hidden="true" tabindex="-1"></a>Hmm. We have 82 schools now, rather than 52. Maybe some schools have multiple types?</span>
<span id="cb95-288"><a href="#cb95-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-291"><a href="#cb95-291" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-292"><a href="#cb95-292" aria-hidden="true" tabindex="-1"></a>schoolTypes <span class="sc">%&gt;%</span> </span>
<span id="cb95-293"><a href="#cb95-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(Skolenhetskod) <span class="sc">%&gt;%</span> </span>
<span id="cb95-294"><a href="#cb95-294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb95-295"><a href="#cb95-295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-296"><a href="#cb95-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-297"><a href="#cb95-297" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Data retrieval</span></span>
<span id="cb95-298"><a href="#cb95-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-299"><a href="#cb95-299" aria-hidden="true" tabindex="-1"></a>Since we have two variables to loop over, we could use a nested <span class="in">`for()`</span> loop, but we could also use <span class="in">`map2()`</span> to retrieve data for all schools.</span>
<span id="cb95-300"><a href="#cb95-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-303"><a href="#cb95-303" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-304"><a href="#cb95-304" aria-hidden="true" tabindex="-1"></a>schoolData <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb95-305"><a href="#cb95-305" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> schoolTypes<span class="sc">$</span>Skolenhetskod,</span>
<span id="cb95-306"><a href="#cb95-306" aria-hidden="true" tabindex="-1"></a>  <span class="at">.y =</span> schoolTypes<span class="sc">$</span>type,</span>
<span id="cb95-307"><a href="#cb95-307" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span> <span class="fu">GET</span>(<span class="fu">paste0</span>(<span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/"</span>, .x,<span class="st">"/statistics/"</span>, .y)) <span class="sc">%&gt;%</span></span>
<span id="cb95-308"><a href="#cb95-308" aria-hidden="true" tabindex="-1"></a>    <span class="fu">content</span>(<span class="st">"text"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb95-309"><a href="#cb95-309" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fromJSON</span>()</span>
<span id="cb95-310"><a href="#cb95-310" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb95-311"><a href="#cb95-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-312"><a href="#cb95-312" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-313"><a href="#cb95-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-314"><a href="#cb95-314" aria-hidden="true" tabindex="-1"></a><span class="fu">### Unnesting multiple lists</span></span>
<span id="cb95-315"><a href="#cb95-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-316"><a href="#cb95-316" aria-hidden="true" tabindex="-1"></a>Next step is to get each schools data from a list element to a dataframe, and then combine all of them. We already did the first part for one school, so let's expand on that.</span>
<span id="cb95-317"><a href="#cb95-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-318"><a href="#cb95-318" aria-hidden="true" tabindex="-1"></a>We'll define a function to get the data from one school.</span>
<span id="cb95-319"><a href="#cb95-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-322"><a href="#cb95-322" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-323"><a href="#cb95-323" aria-hidden="true" tabindex="-1"></a>oneSchool <span class="ot">&lt;-</span> <span class="cf">function</span>(listN) {</span>
<span id="cb95-324"><a href="#cb95-324" aria-hidden="true" tabindex="-1"></a>  schoolUnit <span class="ot">&lt;-</span> schoolData[[listN]]<span class="sc">$</span>body<span class="sc">$</span>schoolUnit</span>
<span id="cb95-325"><a href="#cb95-325" aria-hidden="true" tabindex="-1"></a>  df_total <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb95-326"><a href="#cb95-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-327"><a href="#cb95-327" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(vars)) {</span>
<span id="cb95-328"><a href="#cb95-328" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> schoolData[[listN]]<span class="sc">$</span>body <span class="sc">%&gt;%</span></span>
<span id="cb95-329"><a href="#cb95-329" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pluck</span>(i) <span class="sc">%&gt;%</span></span>
<span id="cb95-330"><a href="#cb95-330" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_column</span>(<span class="at">variable =</span> i,</span>
<span id="cb95-331"><a href="#cb95-331" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Skolenhetskod =</span> schoolUnit)</span>
<span id="cb95-332"><a href="#cb95-332" aria-hidden="true" tabindex="-1"></a>    df_total <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df_total, tmp)</span>
<span id="cb95-333"><a href="#cb95-333" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-334"><a href="#cb95-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_total)</span>
<span id="cb95-335"><a href="#cb95-335" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-336"><a href="#cb95-336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-337"><a href="#cb95-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-338"><a href="#cb95-338" aria-hidden="true" tabindex="-1"></a>Test the function.</span>
<span id="cb95-339"><a href="#cb95-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-342"><a href="#cb95-342" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-343"><a href="#cb95-343" aria-hidden="true" tabindex="-1"></a><span class="fu">oneSchool</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-344"><a href="#cb95-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb95-345"><a href="#cb95-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-346"><a href="#cb95-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-347"><a href="#cb95-347" aria-hidden="true" tabindex="-1"></a>Looks good.</span>
<span id="cb95-348"><a href="#cb95-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-351"><a href="#cb95-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-352"><a href="#cb95-352" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb95-353"><a href="#cb95-353" aria-hidden="true" tabindex="-1"></a>nestedOutput <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(schoolData)), <span class="sc">~</span> <span class="fu">oneSchool</span>(.x))</span>
<span id="cb95-354"><a href="#cb95-354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-355"><a href="#cb95-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-356"><a href="#cb95-356" aria-hidden="true" tabindex="-1"></a>This fails at index 2. **(Code is not run since it won't allow the output to be rendered)**</span>
<span id="cb95-357"><a href="#cb95-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-358"><a href="#cb95-358" aria-hidden="true" tabindex="-1"></a><span class="fu">### Troubleshooting</span></span>
<span id="cb95-359"><a href="#cb95-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-362"><a href="#cb95-362" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-363"><a href="#cb95-363" aria-hidden="true" tabindex="-1"></a>schoolData[[<span class="dv">2</span>]]<span class="sc">$</span>body</span>
<span id="cb95-364"><a href="#cb95-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-365"><a href="#cb95-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-366"><a href="#cb95-366" aria-hidden="true" tabindex="-1"></a>Looks like not all schools have the same data variables. We'll have to work that into the function</span>
<span id="cb95-367"><a href="#cb95-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-370"><a href="#cb95-370" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-371"><a href="#cb95-371" aria-hidden="true" tabindex="-1"></a>oneSchool <span class="ot">&lt;-</span> <span class="cf">function</span>(listN) {</span>
<span id="cb95-372"><a href="#cb95-372" aria-hidden="true" tabindex="-1"></a>  schoolUnit <span class="ot">&lt;-</span> schoolData[[listN]]<span class="sc">$</span>body<span class="sc">$</span>schoolUnit</span>
<span id="cb95-373"><a href="#cb95-373" aria-hidden="true" tabindex="-1"></a>  vars <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">sapply</span>(schoolData[[listN]]<span class="sc">$</span>body, <span class="cf">function</span>(x) <span class="fu">length</span>(x) <span class="sc">&gt;</span> <span class="dv">1</span>))</span>
<span id="cb95-374"><a href="#cb95-374" aria-hidden="true" tabindex="-1"></a>  df_total <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb95-375"><a href="#cb95-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-376"><a href="#cb95-376" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(vars)) {</span>
<span id="cb95-377"><a href="#cb95-377" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> schoolData[[listN]]<span class="sc">$</span>body <span class="sc">%&gt;%</span></span>
<span id="cb95-378"><a href="#cb95-378" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pluck</span>(i) <span class="sc">%&gt;%</span></span>
<span id="cb95-379"><a href="#cb95-379" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_column</span>(<span class="at">variable =</span> i,</span>
<span id="cb95-380"><a href="#cb95-380" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Skolenhetskod =</span> schoolUnit)</span>
<span id="cb95-381"><a href="#cb95-381" aria-hidden="true" tabindex="-1"></a>    df_total <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df_total, tmp)</span>
<span id="cb95-382"><a href="#cb95-382" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-383"><a href="#cb95-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_total)</span>
<span id="cb95-384"><a href="#cb95-384" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-385"><a href="#cb95-385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-386"><a href="#cb95-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-387"><a href="#cb95-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-390"><a href="#cb95-390" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-391"><a href="#cb95-391" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb95-392"><a href="#cb95-392" aria-hidden="true" tabindex="-1"></a>nestedOutput <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(schoolData)), <span class="sc">~</span> <span class="fu">oneSchool</span>(.x))</span>
<span id="cb95-393"><a href="#cb95-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-394"><a href="#cb95-394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-395"><a href="#cb95-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-396"><a href="#cb95-396" aria-hidden="true" tabindex="-1"></a>Failing at index 6... **(Code is not run since it won't allow the output to be rendered)**</span>
<span id="cb95-397"><a href="#cb95-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-400"><a href="#cb95-400" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-401"><a href="#cb95-401" aria-hidden="true" tabindex="-1"></a>schoolData[[<span class="dv">6</span>]]<span class="sc">$</span>body<span class="sc">$</span>programMetrics <span class="sc">%&gt;%</span> </span>
<span id="cb95-402"><a href="#cb95-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span>
<span id="cb95-403"><a href="#cb95-403" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-404"><a href="#cb95-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-405"><a href="#cb95-405" aria-hidden="true" tabindex="-1"></a>There is a variable that has more than 3 columns.</span>
<span id="cb95-406"><a href="#cb95-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-409"><a href="#cb95-409" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-410"><a href="#cb95-410" aria-hidden="true" tabindex="-1"></a>schoolData[[<span class="dv">6</span>]]<span class="sc">$</span>body<span class="sc">$</span>schoolUnit</span>
<span id="cb95-411"><a href="#cb95-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-412"><a href="#cb95-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-413"><a href="#cb95-413" aria-hidden="true" tabindex="-1"></a>No unit code in the data.</span>
<span id="cb95-414"><a href="#cb95-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-417"><a href="#cb95-417" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-418"><a href="#cb95-418" aria-hidden="true" tabindex="-1"></a>schoolTypes <span class="sc">%&gt;%</span> </span>
<span id="cb95-419"><a href="#cb95-419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">6</span>)</span>
<span id="cb95-420"><a href="#cb95-420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-421"><a href="#cb95-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-422"><a href="#cb95-422" aria-hidden="true" tabindex="-1"></a>This is a Gymnasieskola.</span>
<span id="cb95-423"><a href="#cb95-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-426"><a href="#cb95-426" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-427"><a href="#cb95-427" aria-hidden="true" tabindex="-1"></a>schoolTypes <span class="sc">%&gt;%</span> </span>
<span id="cb95-428"><a href="#cb95-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb95-429"><a href="#cb95-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"gy"</span>)</span>
<span id="cb95-430"><a href="#cb95-430" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-431"><a href="#cb95-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-432"><a href="#cb95-432" aria-hidden="true" tabindex="-1"></a>Looks like we have 5 of those. Maybe they all share the same structure?</span>
<span id="cb95-433"><a href="#cb95-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-436"><a href="#cb95-436" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-437"><a href="#cb95-437" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(<span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">16</span>,<span class="dv">74</span>), <span class="sc">~</span> <span class="fu">names</span>(schoolData[[.x]]<span class="sc">$</span>body))</span>
<span id="cb95-438"><a href="#cb95-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-439"><a href="#cb95-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-440"><a href="#cb95-440" aria-hidden="true" tabindex="-1"></a>Indeed. We'll just filter those schools out for now.</span>
<span id="cb95-441"><a href="#cb95-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-444"><a href="#cb95-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-445"><a href="#cb95-445" aria-hidden="true" tabindex="-1"></a>mapSchoolUnits <span class="ot">&lt;-</span> schoolTypes <span class="sc">%&gt;%</span> </span>
<span id="cb95-446"><a href="#cb95-446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb95-447"><a href="#cb95-447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>type <span class="sc">==</span> <span class="st">"gy"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-448"><a href="#cb95-448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(rowname) <span class="sc">%&gt;%</span> </span>
<span id="cb95-449"><a href="#cb95-449" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.numeric</span>()</span>
<span id="cb95-450"><a href="#cb95-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-451"><a href="#cb95-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-452"><a href="#cb95-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-455"><a href="#cb95-455" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-456"><a href="#cb95-456" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb95-457"><a href="#cb95-457" aria-hidden="true" tabindex="-1"></a>nestedOutput <span class="ot">&lt;-</span> <span class="fu">map</span>(mapSchoolUnits, <span class="sc">~</span> <span class="fu">oneSchool</span>(.x))</span>
<span id="cb95-458"><a href="#cb95-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-459"><a href="#cb95-459" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-460"><a href="#cb95-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-461"><a href="#cb95-461" aria-hidden="true" tabindex="-1"></a>Index 19 error.</span>
<span id="cb95-462"><a href="#cb95-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-465"><a href="#cb95-465" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-466"><a href="#cb95-466" aria-hidden="true" tabindex="-1"></a>schoolData[[mapSchoolUnits[<span class="dv">19</span>]]]</span>
<span id="cb95-467"><a href="#cb95-467" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-468"><a href="#cb95-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-469"><a href="#cb95-469" aria-hidden="true" tabindex="-1"></a>Strange that this school has no data when we tested that earlier. But alas, we'll just have to remove it. Note that the type is "vux". We should have filtered on types of interest earlier. This is not really a relevant type for our purposes.</span>
<span id="cb95-470"><a href="#cb95-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-473"><a href="#cb95-473" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-474"><a href="#cb95-474" aria-hidden="true" tabindex="-1"></a>schoolTypes <span class="sc">%&gt;%</span> </span>
<span id="cb95-475"><a href="#cb95-475" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(type)</span>
<span id="cb95-476"><a href="#cb95-476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-477"><a href="#cb95-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-478"><a href="#cb95-478" aria-hidden="true" tabindex="-1"></a>Let's get the full descriptions of these abbreviations.</span>
<span id="cb95-479"><a href="#cb95-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-482"><a href="#cb95-482" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-483"><a href="#cb95-483" aria-hidden="true" tabindex="-1"></a>schoolTypes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb95-484"><a href="#cb95-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-485"><a href="#cb95-485" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> schoolsFiltered<span class="sc">$</span>Skolenhetskod) {</span>
<span id="cb95-486"><a href="#cb95-486" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-487"><a href="#cb95-487" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="fu">paste0</span>(<span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/"</span>, i)) <span class="sc">%&gt;%</span> </span>
<span id="cb95-488"><a href="#cb95-488" aria-hidden="true" tabindex="-1"></a>    <span class="fu">content</span>(<span class="st">"text"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-489"><a href="#cb95-489" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fromJSON</span>()</span>
<span id="cb95-490"><a href="#cb95-490" aria-hidden="true" tabindex="-1"></a>  tmp2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb95-491"><a href="#cb95-491" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>code,</span>
<span id="cb95-492"><a href="#cb95-492" aria-hidden="true" tabindex="-1"></a>    <span class="at">typeDesc =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>displayName,</span>
<span id="cb95-493"><a href="#cb95-493" aria-hidden="true" tabindex="-1"></a>    <span class="at">Skolenhetskod =</span> i)</span>
<span id="cb95-494"><a href="#cb95-494" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb95-495"><a href="#cb95-495" aria-hidden="true" tabindex="-1"></a>  schoolTypes <span class="ot">&lt;-</span> <span class="fu">rbind</span>(schoolTypes,tmp2)</span>
<span id="cb95-496"><a href="#cb95-496" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-497"><a href="#cb95-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-498"><a href="#cb95-498" aria-hidden="true" tabindex="-1"></a>schoolTypes <span class="sc">%&gt;%</span> </span>
<span id="cb95-499"><a href="#cb95-499" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(typeDesc,type)</span>
<span id="cb95-500"><a href="#cb95-500" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-501"><a href="#cb95-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-502"><a href="#cb95-502" aria-hidden="true" tabindex="-1"></a>For our purposes, we are primarily interested in gr and gy, and some stats from fsk, but not the rest. This filtering should of course have been done earlier, but the first part of this post was written on a Saturday after 2 weeks of vacation and my brain was not quite up to speed...</span>
<span id="cb95-503"><a href="#cb95-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-504"><a href="#cb95-504" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data retrieval with filtering on school types</span></span>
<span id="cb95-505"><a href="#cb95-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-506"><a href="#cb95-506" aria-hidden="true" tabindex="-1"></a>We'll do them separately this time, starting with "gr" only.</span>
<span id="cb95-507"><a href="#cb95-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-510"><a href="#cb95-510" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-511"><a href="#cb95-511" aria-hidden="true" tabindex="-1"></a>mapSchoolUnits <span class="ot">&lt;-</span> schoolTypes <span class="sc">%&gt;%</span> </span>
<span id="cb95-512"><a href="#cb95-512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb95-513"><a href="#cb95-513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"gr"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-514"><a href="#cb95-514" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(rowname) <span class="sc">%&gt;%</span> </span>
<span id="cb95-515"><a href="#cb95-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.numeric</span>()</span>
<span id="cb95-516"><a href="#cb95-516" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb95-517"><a href="#cb95-517" aria-hidden="true" tabindex="-1"></a>nestedOutputGR <span class="ot">&lt;-</span> <span class="fu">map</span>(mapSchoolUnits, <span class="sc">~</span> <span class="fu">oneSchool</span>(.x))</span>
<span id="cb95-518"><a href="#cb95-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-519"><a href="#cb95-519" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(nestedOutputGR[[<span class="dv">1</span>]])</span>
<span id="cb95-520"><a href="#cb95-520" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-521"><a href="#cb95-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-522"><a href="#cb95-522" aria-hidden="true" tabindex="-1"></a>Now each school has its own dataframe, stored within the list object <span class="in">`nestedOutputGR`</span>. Next step is to combine them into one dataframe.</span>
<span id="cb95-523"><a href="#cb95-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-524"><a href="#cb95-524" aria-hidden="true" tabindex="-1"></a><span class="fu">### Combining dataframes</span></span>
<span id="cb95-525"><a href="#cb95-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-528"><a href="#cb95-528" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-529"><a href="#cb95-529" aria-hidden="true" tabindex="-1"></a>unnestedOutputGR <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(nestedOutputGR)), <span class="sc">~</span> <span class="fu">do.call</span>(bind_rows, nestedOutputGR[[.x]]))</span>
<span id="cb95-530"><a href="#cb95-530" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(unnestedOutputGR)</span>
<span id="cb95-531"><a href="#cb95-531" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-532"><a href="#cb95-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-533"><a href="#cb95-533" aria-hidden="true" tabindex="-1"></a>Data is now in long format, which will be useful for some uses, and we can use <span class="in">`pivot_wider()`</span> to change format when needed.</span>
<span id="cb95-534"><a href="#cb95-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-535"><a href="#cb95-535" aria-hidden="true" tabindex="-1"></a>All variables are class "character", which is fine for some, but <span class="in">`timePeriod`</span> is a date variable, and <span class="in">`value`</span> has "." for missing and "," as decimal sign. This needs to be modified.</span>
<span id="cb95-536"><a href="#cb95-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-537"><a href="#cb95-537" aria-hidden="true" tabindex="-1"></a><span class="fu">## Variables</span></span>
<span id="cb95-538"><a href="#cb95-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-539"><a href="#cb95-539" aria-hidden="true" tabindex="-1"></a>Let's have a look at the variables available in the data.</span>
<span id="cb95-540"><a href="#cb95-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-543"><a href="#cb95-543" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-544"><a href="#cb95-544" aria-hidden="true" tabindex="-1"></a>unnestedOutputGR <span class="sc">%&gt;%</span> </span>
<span id="cb95-545"><a href="#cb95-545" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(variable)</span>
<span id="cb95-546"><a href="#cb95-546" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-547"><a href="#cb95-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-548"><a href="#cb95-548" aria-hidden="true" tabindex="-1"></a><span class="fu">### Types</span></span>
<span id="cb95-549"><a href="#cb95-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-552"><a href="#cb95-552" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-553"><a href="#cb95-553" aria-hidden="true" tabindex="-1"></a>unnestedOutputGR <span class="sc">%&gt;%</span> </span>
<span id="cb95-554"><a href="#cb95-554" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(valueType)</span>
<span id="cb95-555"><a href="#cb95-555" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-556"><a href="#cb95-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-557"><a href="#cb95-557" aria-hidden="true" tabindex="-1"></a>Let's look at the value variable for the different valueTypes (except EXISTS).</span>
<span id="cb95-558"><a href="#cb95-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-561"><a href="#cb95-561" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-562"><a href="#cb95-562" aria-hidden="true" tabindex="-1"></a>unnestedOutputGR <span class="sc">%&gt;%</span> </span>
<span id="cb95-563"><a href="#cb95-563" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>valueType <span class="sc">==</span> <span class="st">"EXISTS"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-564"><a href="#cb95-564" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(valueType) <span class="sc">%&gt;%</span> </span>
<span id="cb95-565"><a href="#cb95-565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(value)</span>
<span id="cb95-566"><a href="#cb95-566" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-567"><a href="#cb95-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-568"><a href="#cb95-568" aria-hidden="true" tabindex="-1"></a>We need the value variable to be of class numeric, which means only numerics and NA values are allowed.</span>
<span id="cb95-569"><a href="#cb95-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-570"><a href="#cb95-570" aria-hidden="true" tabindex="-1"></a><span class="fu">### Recoding</span></span>
<span id="cb95-571"><a href="#cb95-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-574"><a href="#cb95-574" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-575"><a href="#cb95-575" aria-hidden="true" tabindex="-1"></a><span class="co"># create copy of dataframe prior to recoding</span></span>
<span id="cb95-576"><a href="#cb95-576" aria-hidden="true" tabindex="-1"></a>df.gr <span class="ot">&lt;-</span> unnestedOutputGR</span>
<span id="cb95-577"><a href="#cb95-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-578"><a href="#cb95-578" aria-hidden="true" tabindex="-1"></a><span class="co"># recode . to NA</span></span>
<span id="cb95-579"><a href="#cb95-579" aria-hidden="true" tabindex="-1"></a>df.gr<span class="sc">$</span>value <span class="ot">&lt;-</span> car<span class="sc">::</span><span class="fu">recode</span>(df.gr<span class="sc">$</span>value,<span class="st">"'.'=NA"</span>)</span>
<span id="cb95-580"><a href="#cb95-580" aria-hidden="true" tabindex="-1"></a><span class="co"># change decimal comma to decimal point</span></span>
<span id="cb95-581"><a href="#cb95-581" aria-hidden="true" tabindex="-1"></a>df.gr<span class="sc">$</span>value <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="at">pattern =</span> <span class="st">","</span>,</span>
<span id="cb95-582"><a href="#cb95-582" aria-hidden="true" tabindex="-1"></a>                    <span class="at">replacement =</span> <span class="st">"."</span>,</span>
<span id="cb95-583"><a href="#cb95-583" aria-hidden="true" tabindex="-1"></a>                    df.gr<span class="sc">$</span>value)</span>
<span id="cb95-584"><a href="#cb95-584" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-585"><a href="#cb95-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-586"><a href="#cb95-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-589"><a href="#cb95-589" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-590"><a href="#cb95-590" aria-hidden="true" tabindex="-1"></a><span class="co"># remaining cleanup</span></span>
<span id="cb95-591"><a href="#cb95-591" aria-hidden="true" tabindex="-1"></a>df.gr<span class="sc">$</span>value <span class="ot">&lt;-</span> car<span class="sc">::</span><span class="fu">recode</span>(df.gr<span class="sc">$</span>value,<span class="st">"'..'=NA"</span>) <span class="co"># too few pupils</span></span>
<span id="cb95-592"><a href="#cb95-592" aria-hidden="true" tabindex="-1"></a>df.gr<span class="sc">$</span>value <span class="ot">&lt;-</span> car<span class="sc">::</span><span class="fu">recode</span>(df.gr<span class="sc">$</span>value,<span class="st">"'*'=NA"</span>) <span class="co"># no req for teacher license</span></span>
<span id="cb95-593"><a href="#cb95-593" aria-hidden="true" tabindex="-1"></a>df.gr<span class="sc">$</span>value <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"cirka "</span>, <span class="st">""</span>, df.gr<span class="sc">$</span>value)</span>
<span id="cb95-594"><a href="#cb95-594" aria-hidden="true" tabindex="-1"></a>df.gr<span class="sc">$</span>value <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"~"</span>, <span class="st">""</span>, df.gr<span class="sc">$</span>value)</span>
<span id="cb95-595"><a href="#cb95-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-596"><a href="#cb95-596" aria-hidden="true" tabindex="-1"></a>df.gr<span class="sc">$</span>value <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(df.gr<span class="sc">$</span>value)</span>
<span id="cb95-597"><a href="#cb95-597" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-598"><a href="#cb95-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-599"><a href="#cb95-599" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Date variable</span></span>
<span id="cb95-600"><a href="#cb95-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-601"><a href="#cb95-601" aria-hidden="true" tabindex="-1"></a>First remove the second part of the school year designation (extract the first 4 digits).</span>
<span id="cb95-604"><a href="#cb95-604" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-605"><a href="#cb95-605" aria-hidden="true" tabindex="-1"></a><span class="co"># date variable</span></span>
<span id="cb95-606"><a href="#cb95-606" aria-hidden="true" tabindex="-1"></a>df.gr<span class="sc">$</span>timePeriod <span class="ot">&lt;-</span> <span class="fu">str_extract</span>(df.gr<span class="sc">$</span>timePeriod, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>)</span>
<span id="cb95-607"><a href="#cb95-607" aria-hidden="true" tabindex="-1"></a>df.gr<span class="sc">$</span>timePeriod <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(df.gr<span class="sc">$</span>timePeriod)</span>
<span id="cb95-608"><a href="#cb95-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-609"><a href="#cb95-609" aria-hidden="true" tabindex="-1"></a>df.gr <span class="sc">%&gt;%</span> </span>
<span id="cb95-610"><a href="#cb95-610" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(timePeriod)</span>
<span id="cb95-611"><a href="#cb95-611" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-612"><a href="#cb95-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-613"><a href="#cb95-613" aria-hidden="true" tabindex="-1"></a>We could transform this to a date format variable, but having dates as year numerics is fine for our intended use.</span>
<span id="cb95-614"><a href="#cb95-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-615"><a href="#cb95-615" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visualizing data</span></span>
<span id="cb95-616"><a href="#cb95-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-619"><a href="#cb95-619" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-620"><a href="#cb95-620" aria-hidden="true" tabindex="-1"></a><span class="co"># we like to use school names instead of codes when creating figures</span></span>
<span id="cb95-621"><a href="#cb95-621" aria-hidden="true" tabindex="-1"></a>df.gr <span class="ot">&lt;-</span> <span class="fu">left_join</span>(df.gr,schools, <span class="at">by =</span> <span class="st">"Skolenhetskod"</span>)</span>
<span id="cb95-622"><a href="#cb95-622" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-623"><a href="#cb95-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-624"><a href="#cb95-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-625"><a href="#cb95-625" aria-hidden="true" tabindex="-1"></a><span class="fu">### Variable check</span></span>
<span id="cb95-626"><a href="#cb95-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-629"><a href="#cb95-629" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-630"><a href="#cb95-630" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtsummary)</span>
<span id="cb95-631"><a href="#cb95-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-632"><a href="#cb95-632" aria-hidden="true" tabindex="-1"></a>df.gr <span class="sc">%&gt;%</span> </span>
<span id="cb95-633"><a href="#cb95-633" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(timePeriod,variable) <span class="sc">%&gt;%</span> </span>
<span id="cb95-634"><a href="#cb95-634" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(variable) <span class="sc">%&gt;%</span> </span>
<span id="cb95-635"><a href="#cb95-635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_summary</span>(timePeriod)</span>
<span id="cb95-636"><a href="#cb95-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-637"><a href="#cb95-637" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-638"><a href="#cb95-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-639"><a href="#cb95-639" aria-hidden="true" tabindex="-1"></a><span class="fu">### Number of pupils per school</span></span>
<span id="cb95-640"><a href="#cb95-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-643"><a href="#cb95-643" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-644"><a href="#cb95-644" aria-hidden="true" tabindex="-1"></a>df.gr <span class="sc">%&gt;%</span> </span>
<span id="cb95-645"><a href="#cb95-645" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">"totalNumberOfPupils"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-646"><a href="#cb95-646" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(timePeriod), </span>
<span id="cb95-647"><a href="#cb95-647" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> value, </span>
<span id="cb95-648"><a href="#cb95-648" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> Skolenhetsnamn,</span>
<span id="cb95-649"><a href="#cb95-649" aria-hidden="true" tabindex="-1"></a>             <span class="at">group =</span> Skolenhetsnamn)) <span class="sc">+</span></span>
<span id="cb95-650"><a href="#cb95-650" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb95-651"><a href="#cb95-651" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb95-652"><a href="#cb95-652" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb95-653"><a href="#cb95-653" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-654"><a href="#cb95-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-655"><a href="#cb95-655" aria-hidden="true" tabindex="-1"></a>Only data from 2022 for that variable. We need to look elsewhere for historical data, it seems. It would also be useful to have the number of pupils per class, since we want to make comparisons to survey data responses. However, the documentation of this variable indicates that number of pupils is rounded to nearest 10th:</span>
<span id="cb95-656"><a href="#cb95-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-657"><a href="#cb95-657" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; "Antal elever på skolenheten, avrundat till tiotal.  1-14 elever ger 10, 15-24 elever ger 20, 25-34 elever ger 30, enkelprick förekommer om elever saknas.</span></span>
<span id="cb95-658"><a href="#cb95-658" aria-hidden="true" tabindex="-1"></a><span class="at">Uppgiften samlas in 15 oktober varje år och uppdatering sker i mars året efter insamling."</span></span>
<span id="cb95-659"><a href="#cb95-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-660"><a href="#cb95-660" aria-hidden="true" tabindex="-1"></a>Also, we can see that there are several school units that have very similar names, or represent parts of the same schools. This data is clearly quite complex in its structure.</span>
<span id="cb95-661"><a href="#cb95-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-662"><a href="#cb95-662" aria-hidden="true" tabindex="-1"></a>As a bonus item, here is a more suitable type of figure to illustrate data from a single year, </span>
<span id="cb95-663"><a href="#cb95-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-666"><a href="#cb95-666" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-667"><a href="#cb95-667" aria-hidden="true" tabindex="-1"></a>df.gr <span class="sc">%&gt;%</span> </span>
<span id="cb95-668"><a href="#cb95-668" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">"totalNumberOfPupils"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-669"><a href="#cb95-669" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Skolenhetsnamn =</span> <span class="fu">factor</span>(Skolenhetsnamn)) <span class="sc">%&gt;%</span> </span>
<span id="cb95-670"><a href="#cb95-670" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_reorder</span>(Skolenhetsnamn, <span class="fu">desc</span>(value)), </span>
<span id="cb95-671"><a href="#cb95-671" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> value,</span>
<span id="cb95-672"><a href="#cb95-672" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> value)) <span class="sc">+</span></span>
<span id="cb95-673"><a href="#cb95-673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb95-674"><a href="#cb95-674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb95-675"><a href="#cb95-675" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>,</span>
<span id="cb95-676"><a href="#cb95-676" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Number of pupils"</span>) <span class="sc">+</span></span>
<span id="cb95-677"><a href="#cb95-677" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb95-678"><a href="#cb95-678" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span>
<span id="cb95-679"><a href="#cb95-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-680"><a href="#cb95-680" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-681"><a href="#cb95-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-682"><a href="#cb95-682" aria-hidden="true" tabindex="-1"></a><span class="fu">### studentsPerTeacherQuota</span></span>
<span id="cb95-683"><a href="#cb95-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-684"><a href="#cb95-684" aria-hidden="true" tabindex="-1"></a>Here we have data from multiple school years.</span>
<span id="cb95-685"><a href="#cb95-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-688"><a href="#cb95-688" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-689"><a href="#cb95-689" aria-hidden="true" tabindex="-1"></a>df.gr <span class="sc">%&gt;%</span> </span>
<span id="cb95-690"><a href="#cb95-690" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">"studentsPerTeacherQuota"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-691"><a href="#cb95-691" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(timePeriod), </span>
<span id="cb95-692"><a href="#cb95-692" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> value, </span>
<span id="cb95-693"><a href="#cb95-693" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> Skolenhetsnamn,</span>
<span id="cb95-694"><a href="#cb95-694" aria-hidden="true" tabindex="-1"></a>             <span class="at">group =</span> Skolenhetsnamn)) <span class="sc">+</span></span>
<span id="cb95-695"><a href="#cb95-695" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb95-696"><a href="#cb95-696" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb95-697"><a href="#cb95-697" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb95-698"><a href="#cb95-698" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-699"><a href="#cb95-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-700"><a href="#cb95-700" aria-hidden="true" tabindex="-1"></a>Huge variation, probably since there are schools in the data that seem to represent special education groups. Let's look at the average numbers across years and sort out the 10 with the lowest number of pupils per teacher.</span>
<span id="cb95-701"><a href="#cb95-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-704"><a href="#cb95-704" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-705"><a href="#cb95-705" aria-hidden="true" tabindex="-1"></a>df.gr <span class="sc">%&gt;%</span> </span>
<span id="cb95-706"><a href="#cb95-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">"studentsPerTeacherQuota"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-707"><a href="#cb95-707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Skolenhetsnamn) <span class="sc">%&gt;%</span> </span>
<span id="cb95-708"><a href="#cb95-708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">Average =</span> <span class="fu">mean</span>(value)) <span class="sc">%&gt;%</span> </span>
<span id="cb95-709"><a href="#cb95-709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Average) <span class="sc">%&gt;%</span> </span>
<span id="cb95-710"><a href="#cb95-710" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb95-711"><a href="#cb95-711" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-712"><a href="#cb95-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-713"><a href="#cb95-713" aria-hidden="true" tabindex="-1"></a>We'll remove the ones with "1GR" at the end of the school name.</span>
<span id="cb95-714"><a href="#cb95-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-717"><a href="#cb95-717" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-718"><a href="#cb95-718" aria-hidden="true" tabindex="-1"></a>df.gr <span class="sc">%&gt;%</span> </span>
<span id="cb95-719"><a href="#cb95-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">"studentsPerTeacherQuota"</span>,</span>
<span id="cb95-720"><a href="#cb95-720" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">str_detect</span>(Skolenhetsnamn,<span class="st">"1GR"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb95-721"><a href="#cb95-721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(timePeriod), </span>
<span id="cb95-722"><a href="#cb95-722" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> value, </span>
<span id="cb95-723"><a href="#cb95-723" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> Skolenhetsnamn</span>
<span id="cb95-724"><a href="#cb95-724" aria-hidden="true" tabindex="-1"></a>             )) <span class="sc">+</span></span>
<span id="cb95-725"><a href="#cb95-725" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb95-726"><a href="#cb95-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> Skolenhetsnamn)) <span class="sc">+</span></span>
<span id="cb95-727"><a href="#cb95-727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb95-728"><a href="#cb95-728" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-729"><a href="#cb95-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-730"><a href="#cb95-730" aria-hidden="true" tabindex="-1"></a>Let's update our information about the schools with some more variables. This will get a bit complicated since an API call for a school unit that has more than one type will contain strings for some variables instead of single values. Also, the <span class="in">`schoolYear`</span> variable is a string in itself, so we need to get the first and last value from that and combine into one value.</span>
<span id="cb95-731"><a href="#cb95-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-734"><a href="#cb95-734" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-735"><a href="#cb95-735" aria-hidden="true" tabindex="-1"></a>schoolUnitCodes <span class="ot">&lt;-</span> schoolTypes <span class="sc">%&gt;%</span> </span>
<span id="cb95-736"><a href="#cb95-736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"gr"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-737"><a href="#cb95-737" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(Skolenhetskod)</span>
<span id="cb95-738"><a href="#cb95-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-739"><a href="#cb95-739" aria-hidden="true" tabindex="-1"></a>schoolTypes2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>() <span class="co"># making a new dataframe, to avoid overwriting the old one when we test things</span></span>
<span id="cb95-740"><a href="#cb95-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-741"><a href="#cb95-741" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> schoolUnitCodes) {</span>
<span id="cb95-742"><a href="#cb95-742" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-743"><a href="#cb95-743" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="fu">paste0</span>(<span class="st">"https://api.skolverket.se/planned-educations/v3/school-units/"</span>, i)) <span class="sc">%&gt;%</span> </span>
<span id="cb95-744"><a href="#cb95-744" aria-hidden="true" tabindex="-1"></a>    <span class="fu">content</span>(<span class="st">"text"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-745"><a href="#cb95-745" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fromJSON</span>()</span>
<span id="cb95-746"><a href="#cb95-746" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-747"><a href="#cb95-747" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(tmp<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>code) <span class="sc">&gt;</span> <span class="dv">1</span>){ <span class="co"># if both fsk and gr</span></span>
<span id="cb95-748"><a href="#cb95-748" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-749"><a href="#cb95-749" aria-hidden="true" tabindex="-1"></a>    tmp2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb95-750"><a href="#cb95-750" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>code[<span class="dv">2</span>],</span>
<span id="cb95-751"><a href="#cb95-751" aria-hidden="true" tabindex="-1"></a>    <span class="at">principalOrganizerType =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>principalOrganizerType,</span>
<span id="cb95-752"><a href="#cb95-752" aria-hidden="true" tabindex="-1"></a>    <span class="at">companyForm =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>companyForm,</span>
<span id="cb95-753"><a href="#cb95-753" aria-hidden="true" tabindex="-1"></a>    <span class="at">schoolYears =</span> <span class="fu">paste0</span>(tmp<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>schoolYears[<span class="dv">2</span>][[<span class="dv">1</span>]][<span class="dv">1</span>],<span class="st">"-"</span>,tmp<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>schoolYears[<span class="dv">2</span>][[<span class="dv">1</span>]][<span class="fu">length</span>(tmp<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>schoolYears[<span class="dv">2</span>][[<span class="dv">1</span>]])]),</span>
<span id="cb95-754"><a href="#cb95-754" aria-hidden="true" tabindex="-1"></a>    <span class="at">corporationName =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>corporationName,</span>
<span id="cb95-755"><a href="#cb95-755" aria-hidden="true" tabindex="-1"></a>    <span class="at">latitude =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>wgs84_Lat,</span>
<span id="cb95-756"><a href="#cb95-756" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitude =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>wgs84_Long,</span>
<span id="cb95-757"><a href="#cb95-757" aria-hidden="true" tabindex="-1"></a>    <span class="at">zipCode =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>contactInfo<span class="sc">$</span>addresses<span class="sc">$</span>zipCode[<span class="dv">2</span>],</span>
<span id="cb95-758"><a href="#cb95-758" aria-hidden="true" tabindex="-1"></a>    <span class="at">Skolenhetskod =</span> i)</span>
<span id="cb95-759"><a href="#cb95-759" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb95-760"><a href="#cb95-760" aria-hidden="true" tabindex="-1"></a>  schoolTypes2 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(schoolTypes2,tmp2)</span>
<span id="cb95-761"><a href="#cb95-761" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { <span class="co"># when schoolType only "gr"</span></span>
<span id="cb95-762"><a href="#cb95-762" aria-hidden="true" tabindex="-1"></a>    tmp2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb95-763"><a href="#cb95-763" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>code,</span>
<span id="cb95-764"><a href="#cb95-764" aria-hidden="true" tabindex="-1"></a>    <span class="at">principalOrganizerType =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>principalOrganizerType,</span>
<span id="cb95-765"><a href="#cb95-765" aria-hidden="true" tabindex="-1"></a>    <span class="at">companyForm =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>companyForm,</span>
<span id="cb95-766"><a href="#cb95-766" aria-hidden="true" tabindex="-1"></a>    <span class="at">schoolYears =</span> <span class="fu">paste0</span>(tmp<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>schoolYears[<span class="dv">1</span>][[<span class="dv">1</span>]][<span class="dv">1</span>],<span class="st">"-"</span>,tmp<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>schoolYears[<span class="dv">1</span>][[<span class="dv">1</span>]][<span class="fu">length</span>(tmp<span class="sc">$</span>body<span class="sc">$</span>typeOfSchooling<span class="sc">$</span>schoolYears[<span class="dv">1</span>][[<span class="dv">1</span>]])]),</span>
<span id="cb95-767"><a href="#cb95-767" aria-hidden="true" tabindex="-1"></a>    <span class="at">corporationName =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>corporationName,</span>
<span id="cb95-768"><a href="#cb95-768" aria-hidden="true" tabindex="-1"></a>    <span class="at">latitude =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>wgs84_Lat,</span>
<span id="cb95-769"><a href="#cb95-769" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitude =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>wgs84_Long,</span>
<span id="cb95-770"><a href="#cb95-770" aria-hidden="true" tabindex="-1"></a>    <span class="at">zipCode =</span> tmp<span class="sc">$</span>body<span class="sc">$</span>contactInfo<span class="sc">$</span>addresses<span class="sc">$</span>zipCode,</span>
<span id="cb95-771"><a href="#cb95-771" aria-hidden="true" tabindex="-1"></a>    <span class="at">Skolenhetskod =</span> i)</span>
<span id="cb95-772"><a href="#cb95-772" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb95-773"><a href="#cb95-773" aria-hidden="true" tabindex="-1"></a>  schoolTypes2 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(schoolTypes2,tmp2)</span>
<span id="cb95-774"><a href="#cb95-774" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-775"><a href="#cb95-775" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-776"><a href="#cb95-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-777"><a href="#cb95-777" aria-hidden="true" tabindex="-1"></a>schoolTypes2 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(schoolTypes2,schools, <span class="at">by =</span> <span class="st">"Skolenhetskod"</span>)</span>
<span id="cb95-778"><a href="#cb95-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-779"><a href="#cb95-779" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(schoolTypes2)</span>
<span id="cb95-780"><a href="#cb95-780" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-781"><a href="#cb95-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-782"><a href="#cb95-782" aria-hidden="true" tabindex="-1"></a>Well, that was a handful to work out. And we only get "gr" schools, so a similar process will be necessary if we want to get the other school types. It should at least be a lot quicker since we have worked out some solutions already, depending on the differences in data structure.</span>
<span id="cb95-783"><a href="#cb95-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-784"><a href="#cb95-784" aria-hidden="true" tabindex="-1"></a><span class="fu">## More demographics</span></span>
<span id="cb95-785"><a href="#cb95-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-786"><a href="#cb95-786" aria-hidden="true" tabindex="-1"></a>It seems that there are other types of data available for manual download that I am unable to find using the API documentation and exploration. I emailed Skolverket and asked them if it is possible to retrieve this data via API, and while waiting for a response I manually downloaded the files and combined them. The website URL for manual downloads is <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.skolverket.se/skolutveckling/statistik/sok-statistik-om-forskola-skola-och-vuxenutbildning?sok=SokD&amp;niva=S&amp;omr=elever&amp;exp=6&amp;lasar=2022&amp;uttag=null)</span></span>
<span id="cb95-787"><a href="#cb95-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-788"><a href="#cb95-788" aria-hidden="true" tabindex="-1"></a>I've limited this example to the last five years, thus five files.</span>
<span id="cb95-789"><a href="#cb95-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-790"><a href="#cb95-790" aria-hidden="true" tabindex="-1"></a>First, let's read one file. I've already done some exploring here, which resulted in skipping the first five rows (which contains what should be meta-data basically) and using semi-colon for separation of data fields. Also, the amazing <span class="in">`janitor::clean_names()`</span> is used, an empty variable is removed, and a year variable is added.</span>
<span id="cb95-791"><a href="#cb95-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-792"><a href="#cb95-792" aria-hidden="true" tabindex="-1"></a>Specifying "." and ".." as missing data indicators would seem accurate, but doing this when importing data screws up decimal points later, so we need a manual recode after import.</span>
<span id="cb95-793"><a href="#cb95-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-796"><a href="#cb95-796" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-797"><a href="#cb95-797" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb95-798"><a href="#cb95-798" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb95-799"><a href="#cb95-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-800"><a href="#cb95-800" aria-hidden="true" tabindex="-1"></a><span class="fu">read_delim</span>(<span class="st">"data/Grundskolan - Antal elever per årskurs 2022 Skolenhet.csv"</span>,</span>
<span id="cb95-801"><a href="#cb95-801" aria-hidden="true" tabindex="-1"></a>                 <span class="at">skip =</span> <span class="dv">5</span>, <span class="at">delim =</span> <span class="st">";"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb95-802"><a href="#cb95-802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb95-803"><a href="#cb95-803" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span>x23) <span class="sc">%&gt;%</span></span>
<span id="cb95-804"><a href="#cb95-804" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(<span class="at">year =</span> <span class="dv">2022</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-805"><a href="#cb95-805" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span>
<span id="cb95-806"><a href="#cb95-806" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-807"><a href="#cb95-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-808"><a href="#cb95-808" aria-hidden="true" tabindex="-1"></a>Some recodings are in order.</span>
<span id="cb95-809"><a href="#cb95-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-812"><a href="#cb95-812" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-813"><a href="#cb95-813" aria-hidden="true" tabindex="-1"></a><span class="fu">read_delim</span>(<span class="st">"data/Grundskolan - Antal elever per årskurs 2022 Skolenhet.csv"</span>,</span>
<span id="cb95-814"><a href="#cb95-814" aria-hidden="true" tabindex="-1"></a>                 <span class="at">skip =</span> <span class="dv">5</span>, <span class="at">delim =</span> <span class="st">";"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb95-815"><a href="#cb95-815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb95-816"><a href="#cb95-816" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span>x23) <span class="sc">%&gt;%</span></span>
<span id="cb95-817"><a href="#cb95-817" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(<span class="at">year =</span> <span class="dv">2022</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-818"><a href="#cb95-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(elever_forskoleklass<span class="sc">:</span>elever_arskurs_9, <span class="sc">~</span> car<span class="sc">::</span><span class="fu">recode</span>(.x,<span class="st">"'.'=NA;'..'=NA"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb95-819"><a href="#cb95-819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"andel"</span>), <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">","</span>,<span class="st">"."</span>,.x))) <span class="sc">%&gt;%</span> </span>
<span id="cb95-820"><a href="#cb95-820" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"andel"</span>), <span class="sc">~</span> <span class="fu">as.numeric</span>(.x))) <span class="sc">%&gt;%</span> </span>
<span id="cb95-821"><a href="#cb95-821" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">elever_arskurs_1_9 =</span> <span class="fu">as.numeric</span>(elever_arskurs_1_9),</span>
<span id="cb95-822"><a href="#cb95-822" aria-hidden="true" tabindex="-1"></a>           <span class="at">skol_enhetskod =</span> <span class="fu">as.numeric</span>(skol_enhetskod)) <span class="sc">%&gt;%</span> </span>
<span id="cb95-823"><a href="#cb95-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span>
<span id="cb95-824"><a href="#cb95-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-825"><a href="#cb95-825" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-826"><a href="#cb95-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-827"><a href="#cb95-827" aria-hidden="true" tabindex="-1"></a>And now, putting all files into the same dataframe.</span>
<span id="cb95-828"><a href="#cb95-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-831"><a href="#cb95-831" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-832"><a href="#cb95-832" aria-hidden="true" tabindex="-1"></a><span class="co"># get all filenames in the folder</span></span>
<span id="cb95-833"><a href="#cb95-833" aria-hidden="true" tabindex="-1"></a>fileList <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">"data/"</span>, <span class="at">full.names=</span><span class="cn">TRUE</span>)</span>
<span id="cb95-834"><a href="#cb95-834" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2018</span><span class="sc">:</span><span class="dv">2022</span>)</span>
<span id="cb95-835"><a href="#cb95-835" aria-hidden="true" tabindex="-1"></a><span class="co"># create an empty list to store data in</span></span>
<span id="cb95-836"><a href="#cb95-836" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb95-837"><a href="#cb95-837" aria-hidden="true" tabindex="-1"></a><span class="co"># loop over filenames to import them to the list object</span></span>
<span id="cb95-838"><a href="#cb95-838" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(fileList))) {</span>
<span id="cb95-839"><a href="#cb95-839" aria-hidden="true" tabindex="-1"></a>  data[[i]] <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(fileList[i],</span>
<span id="cb95-840"><a href="#cb95-840" aria-hidden="true" tabindex="-1"></a>                 <span class="at">skip =</span> <span class="dv">5</span>, <span class="at">delim =</span> <span class="st">";"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb95-841"><a href="#cb95-841" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb95-842"><a href="#cb95-842" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span>x23) <span class="sc">%&gt;%</span></span>
<span id="cb95-843"><a href="#cb95-843" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(<span class="at">year =</span> years[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb95-844"><a href="#cb95-844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(elever_forskoleklass<span class="sc">:</span>elever_arskurs_9, <span class="sc">~</span> car<span class="sc">::</span><span class="fu">recode</span>(.x,<span class="st">"'.'=NA;'..'=NA"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb95-845"><a href="#cb95-845" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"andel"</span>), <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">","</span>,<span class="st">"."</span>,.x))) <span class="sc">%&gt;%</span> </span>
<span id="cb95-846"><a href="#cb95-846" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"andel"</span>), <span class="sc">~</span> <span class="fu">as.numeric</span>(.x))) <span class="sc">%&gt;%</span> </span>
<span id="cb95-847"><a href="#cb95-847" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">elever_arskurs_1_9 =</span> <span class="fu">as.numeric</span>(elever_arskurs_1_9),</span>
<span id="cb95-848"><a href="#cb95-848" aria-hidden="true" tabindex="-1"></a>           <span class="at">skol_enhetskod =</span> <span class="fu">as.numeric</span>(skol_enhetskod))</span>
<span id="cb95-849"><a href="#cb95-849" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-850"><a href="#cb95-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-851"><a href="#cb95-851" aria-hidden="true" tabindex="-1"></a><span class="do">### Combine all nested lists into one dataframe</span></span>
<span id="cb95-852"><a href="#cb95-852" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>), <span class="sc">~</span> <span class="fu">do.call</span>(bind_rows, data[[.x]]))</span>
<span id="cb95-853"><a href="#cb95-853" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(df)</span>
<span id="cb95-854"><a href="#cb95-854" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-855"><a href="#cb95-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-856"><a href="#cb95-856" aria-hidden="true" tabindex="-1"></a>There we go. And now we can write to a compressed file if we want to.</span>
<span id="cb95-857"><a href="#cb95-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-860"><a href="#cb95-860" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-861"><a href="#cb95-861" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb95-862"><a href="#cb95-862" aria-hidden="true" tabindex="-1"></a><span class="fu">write_parquet</span>(df,<span class="st">"SkolverketData.parquet"</span>)</span>
<span id="cb95-863"><a href="#cb95-863" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>