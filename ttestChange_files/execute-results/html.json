{
  "hash": "7f91a87bb8b95e790ce2ac599bb9e3c7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Analyzing individual change with t-tests\"\nauthor: \n  name: Magnus Johansson\n  affiliation: RISE Research Institutes of Sweden\n  affiliation-url: https://www.ri.se/sv/vad-vi-gor/expertiser/kategoriskt-baserade-matningar\n  orcid: 0000-0003-1669-592X\ndate: last-modified\ncitation:\n  type: 'webpage'\ncsl: apa.csl\nexecute: \n  cache: true\n  warning: false\n  message: false\neditor: \n  markdown: \n    wrap: 72\neditor_options: \n  chunk_output_type: console\nbibliography: ttest.bib\n---\n\n\n## Introduction\n\nWhen one uses Rasch or Item Response Theory to estimate measurement values on the latent scale it is also easy to estimate an \"individualized\" measurement error for each value estimated. It has been suggested that a useful way to use this output when analyzing data with two repeated measurement points is to conduct one paired t-test for each individual, comparing the pre/post measurements and using their respective measurement error as the \"population standard error\" [@hobart_effect_2010].\n\nThis strategy results in measurably detectable change for individuals across two time points. Whether this change is meaningful requires  external validation to determine. Since measurement error is not equal across the continuum, how large the measurably detactable change is will also vary depending on the pre-measurement value.\n\nAll the usual limitations and caveats with t-tests apply. This post is not an endorsement of using multiple t-tests as a primary strategy of analysis, but it may be an interesting perspective that takes measurement error into account and focuses on individual outcomes.\n\n::: {.callout-note}\nThis is work in progress and will be updated and expanded on. The first aim is to share code to do individual t-tests of theta+SEM and summarise the results. Later on, we'll look at other methods to analyze longitudinal data, both looking at group level and individual level change.\n:::\n\nThe reliability of the scale/test will of course heavily influence the possibility of detecting change over time. In the Rasch Measurement Theory and Item Response Theory paradigm, reliability is not a single point value that is constant across the latent continuum (REF to separate post on reliability). Depending on the item threshold locations, the test has varying reliability. \n\nLater in this post, I will present a figure describing the Test Information Function, and then a figure with the SEM values across the latent continuum.\n\nAs shown in the separate post on reliability (LINK), SEM * 1.96 will contain the true value in  95% of cases.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(eRm)\nlibrary(janitor)\nlibrary(RISEkbmRasch)\nlibrary(lme4)\nlibrary(modelsummary)\nlibrary(broom.mixed)\nlibrary(marginaleffects)\nlibrary(faux)\nlibrary(ggdist)\n\n### some commands exist in multiple packages, here we define preferred ones that are frequently used\nselect <- dplyr::select\ncount <- dplyr::count\nrecode <- car::recode\nrename <- dplyr::rename\n\ntheme_rise <- function(fontfamily = \"Lato\", axissize = 13, titlesize = 15,\n                       margins = 12, axisface = \"plain\", panelDist = 0.6, ...) {\n  theme_minimal() +\n  theme(\n    text = element_text(family = fontfamily),\n    axis.title.x = element_text(\n      margin = margin(t = margins),\n      size = axissize\n    ),\n    axis.title.y = element_text(\n      margin = margin(r = margins),\n      size = axissize\n    ),\n    plot.title = element_text(\n      face = \"bold\",\n      size = titlesize\n    ),\n    axis.title = element_text(\n      face = axisface\n    ),\n    plot.caption = element_text(\n      face = \"italic\"\n    ),\n    legend.text = element_text(family = fontfamily),\n    legend.background = element_rect(color = \"lightgrey\"),\n    strip.background = element_rect(color = \"lightgrey\"),\n    panel.spacing = unit(panelDist, \"cm\", data = NULL),\n    panel.border = element_rect(color = \"grey\", fill = NA),\n    ...\n  )\n}\n\ntheme_set(theme_rise())\n```\n:::\n\n\n## Simulating longitudinal data\n\n3 time points for later use. First, we'll focus on t1 and t3 and run the t-tests focusing on individual change.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1523)\n\ndata_g1 <- rnorm_multi(n = 250, \n                  mu = c(-0.25, 0, 0.25),\n                  sd = c(1, 1, 1),\n                  r = c(0.5), \n                  varnames = c(\"t_1\", \"t_2\", \"t_3\"),\n                  empirical = FALSE) %>% \n  add_column(group = \"treatment\") %>% \n  rownames_to_column(\"id\")\n\ndata_g2 <- rnorm_multi(n = 250, \n                  mu = c(-0.25, -0.15, -0.05),\n                  sd = c(1, 1, 1),\n                  r = c(0.5), \n                  varnames = c(\"t_1\", \"t_2\", \"t_3\"),\n                  empirical = FALSE) %>% \n  add_column(group = \"control\") %>% \n  mutate(id = c(251:500))\n\nd <- rbind(data_g1,data_g2)\n\nd_long <- d %>% \n  pivot_longer(starts_with(\"t\")) %>% \n  mutate(time = as.numeric(gsub(\"t_\",\"\",name))) %>% \n  select(!name)\n```\n:::\n\n\n### Simulate response data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# item list for simulation\ntlist <- list(\n  t1 = list(1.2, 1.8, 2.4),\n  t2 = list(-1.3, -0.5, 0.5),\n  t3 = list(-0.3, 0.3, 1.2),\n  t4 = list(0.1, 0.6, 1.6),\n  t5 = list(-0.3, 0.7, 1.5),\n  t6 = list(-1.6, -1, -0.3),\n  t7 = list(1, 1.8, 2.5),\n  t8 = list(-1.3, -0.7, 0.4),\n  t9 = list(-0.8, 1.4, 1.9),\n  t10 = list(0.25, 1.25, 2.15)\n)\n\ninputDeltas <- tibble(\n  q1 = c(1.2, 1.8, 2.4),\n  q2 = c(-1.3, -0.5, 0.5),\n  q3 = c(-0.3, 0.3, 1.2),\n  q4 = c(0.1, 0.6, 1.6),\n  q5 = c(-0.3, 0.7, 1.5),\n  q6 = c(-1.6, -1, -0.3),\n  q7 = c(1, 1.8, 2.5),\n  q8 = c(-1.3, -0.7, 0.4),\n  q9 = c(-0.8, 1.4, 1.9),\n  q10 = c(0.25, 1.25, 2.15)\n) %>%\n  t() %>%\n  as.data.frame() %>%\n  mutate(Average = rowMeans(., na.rm = T)) %>% \n  mutate_if(is.double, round, digits = 2) %>% \n  rownames_to_column(var = \"Item\") %>% \n  dplyr::rename(T1 = V1,\n         T2 = V2,\n         T3 = V3)\n\n# simulate response data based on the above defined item thresholds\ntd <- SimPartialScore(\n  deltaslist = tlist,\n  thetavec = d_long$value\n) %>%\n  as.data.frame()\n```\n:::\n\n\n### Estimating item threshold locations\n\nWe could use the parameters from the input, but to add some real world usage to the setup, we'll stack the response data and estimate the item threshold locations using the `eRm` package with the Partial Credig Model and Conditional Maximum Likelihood.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nerm_item_parameters <- RIitemparams(td, output = \"dataframe\") %>% \n  select(!Location) %>% \n  rename(T1 = `Threshold 1`,\n         T2 = `Threshold 2`,\n         T3 = `Threshold 3`) %>% \n  as.matrix()\n\n# center item parameters to sum = 0\nerm_item_parameters <- erm_item_parameters - mean(erm_item_parameters)\n```\n:::\n\n\n### Estimating person locations and SEM\n\nUsing Weighted Likelihood (Warm, 1989) to minimize bias.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# estimate thetas/person locations, based on eRm estimated item thresholds\nerm_thetas <- RIestThetas(td, itemParams = erm_item_parameters)\n\n# estimate measurement error (SEM)\nerm_sem <- map_vec(erm_thetas, ~ catR::semTheta(.x, it = erm_item_parameters, method = \"WL\", model = \"PCM\"))\n\nd_long$erm_thetas <- erm_thetas\nd_long$erm_sem <- erm_sem\n```\n:::\n\n\n## Change\n\nHow many have changed 0.5+ logits (the mean change simulated, also corresponding to 0.5 SD) in the generated data? This could serve as a reference.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d %>% \n  mutate(change = t_3 - t_1)\n\nsummary(d$change)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n-2.4126 -0.4427  0.2565  0.2682  0.9909  3.0004 \n```\n\n\n:::\n\n```{.r .cell-code}\nsd(d$change)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1.00556\n```\n\n\n:::\n\n```{.r .cell-code}\nsd(d$t_3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1.02455\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot(d, aes(x = change, fill = group, color = group)) +\n  #geom_histogram() +\n  stat_dotsinterval(color = \"black\", slab_color = \"white\", slab_linewidth = 0.5) +\n  facet_wrap(~ group) +\n  guides(fill = \"none\", color = \"none\")\n```\n\n::: {.cell-output-display}\n![](ttestChange_files/figure-html/unnamed-chunk-6-1.png){width=1050}\n:::\n\n```{.r .cell-code}\nd %>% \n  mutate(change_grp = case_when(change > 0.5 ~ \"Improved > 0.5\",\n                                change < -0.5 ~ \"Worsened > 0.5\",\n                                TRUE ~ \"In between\")) %>% \n  group_by(group) %>% \n  count(change_grp) %>% \n  kbl_rise(tbl_width = 40) %>% \n  row_spec(c(1,4),bold=TRUE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table data-quarto-disable-processing=\"true\" style=\"width:40%; font-size: 14px;  font-family: Arial; margin-left: auto; margin-right: auto;\" class=\"table table-striped table-hover lightable-classic\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;position: sticky; top:0; background-color: #FFFFFF;font-weight: bold;\"> group </th>\n   <th style=\"text-align:left;position: sticky; top:0; background-color: #FFFFFF;font-weight: bold;\"> change_grp </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;font-weight: bold;\"> n </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> control </td>\n   <td style=\"text-align:left;font-weight: bold;\"> Improved &gt; 0.5 </td>\n   <td style=\"text-align:right;font-weight: bold;\"> 82 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> control </td>\n   <td style=\"text-align:left;\"> In between </td>\n   <td style=\"text-align:right;\"> 95 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> control </td>\n   <td style=\"text-align:left;\"> Worsened &gt; 0.5 </td>\n   <td style=\"text-align:right;\"> 73 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> treatment </td>\n   <td style=\"text-align:left;font-weight: bold;\"> Improved &gt; 0.5 </td>\n   <td style=\"text-align:right;font-weight: bold;\"> 124 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treatment </td>\n   <td style=\"text-align:left;\"> In between </td>\n   <td style=\"text-align:right;\"> 85 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treatment </td>\n   <td style=\"text-align:left;\"> Worsened &gt; 0.5 </td>\n   <td style=\"text-align:right;\"> 41 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### Test information function\n\n\n::: {.cell}\n\n```{.r .cell-code}\nRItif(td, samplePSI = TRUE)\n```\n\n::: {.cell-output-display}\n![](ttestChange_files/figure-html/unnamed-chunk-7-1.png){width=1050}\n:::\n:::\n\n\n\n## t-tests of individual change\n\nOnly using t1 and t3 estimated person locations/thetas and SEM values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd_wide_tt <- d_long %>% \n  pivot_wider(values_from = c(erm_thetas,erm_sem),\n              id_cols = c(id,group),\n              names_from = time\n              ) %>% \n  mutate(id = as.numeric(id))\n\n# basic formula for t-test\n# (d_wide_tt$erm_thetas_1[1] - d_wide_tt$erm_thetas_3[1]) / sqrt(d_wide_tt$erm_sem_1[1] + d_wide_tt$erm_sem_3[1])\n\n# t-tests for all rows in dataframe\nt_values <- c()\nfor (i in 1:nrow(d_wide_tt)) {\n t_values[i] <- (d_wide_tt$erm_thetas_3[i] - d_wide_tt$erm_thetas_1[i]) / sqrt(d_wide_tt$erm_sem_3[i] + d_wide_tt$erm_sem_1[i])\n}\n\ndata.frame(t_values = t_values,\n           group = rep(c(\"Intervention\",\"Control\"), each = 250)) %>% \n  mutate(result = case_when(t_values > 1.96 ~ \"Improved\",\n                            t_values < -1.96 ~ \"Worsened\",\n                            TRUE ~ \"No detectable change\")) %>% \n  group_by(group) %>% \n  count(result) %>% \n  kbl_rise(tbl_width = 40) %>% \n  row_spec(c(1,4),bold=TRUE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table data-quarto-disable-processing=\"true\" style=\"width:40%; font-size: 14px;  font-family: Arial; margin-left: auto; margin-right: auto;\" class=\"table table-striped table-hover lightable-classic\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;position: sticky; top:0; background-color: #FFFFFF;font-weight: bold;\"> group </th>\n   <th style=\"text-align:left;position: sticky; top:0; background-color: #FFFFFF;font-weight: bold;\"> result </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;font-weight: bold;\"> n </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Control </td>\n   <td style=\"text-align:left;font-weight: bold;\"> Improved </td>\n   <td style=\"text-align:right;font-weight: bold;\"> 12 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Control </td>\n   <td style=\"text-align:left;\"> No detectable change </td>\n   <td style=\"text-align:right;\"> 229 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Control </td>\n   <td style=\"text-align:left;\"> Worsened </td>\n   <td style=\"text-align:right;\"> 9 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Intervention </td>\n   <td style=\"text-align:left;font-weight: bold;\"> Improved </td>\n   <td style=\"text-align:right;font-weight: bold;\"> 27 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Intervention </td>\n   <td style=\"text-align:left;\"> No detectable change </td>\n   <td style=\"text-align:right;\"> 219 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Intervention </td>\n   <td style=\"text-align:left;\"> Worsened </td>\n   <td style=\"text-align:right;\"> 4 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n### \"Recovery\" of n changed\n\nAgain, strongly affected by precision/reliability\n\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}